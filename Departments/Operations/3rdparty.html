<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>3rd Party Collection</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* Core styles */
  * { box-sizing: border-box; }
  html, body { height: 100%; display: flex; flex-direction: column; font-family: 'Montserrat', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
  main { flex: 1; }

  nav { background-color: #2c3e50; padding: 15px 25px; color: white; }
  .nav-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
  .logo { font-size: 20px; font-weight: 700; color: white; }
  .nav-links { display: flex; flex-wrap: wrap; gap: 15px; }
  .nav-item { color: white; text-decoration: none; font-size: 16px; padding: 10px 15px; background: none; border: none; border-radius: 6px; cursor: pointer; }
  .nav-item:hover { background-color: white; color: #2c3e50; }
  .menu-toggle { display: none; flex-direction: column; cursor: pointer; margin-left: auto; gap: 4px; }
  .menu-toggle span { height: 3px; width: 25px; background: white; border-radius: 3px; }
  .nav-links.show { display: flex; flex-direction: column; width: 100%; margin-top: 10px; }
  @media (max-width: 768px) { 
    .menu-toggle { display: flex; } 
    .nav-links { display: none; flex-direction: column; width: 100%; margin-top: 10px; } 
    .nav-item { width: 100%; padding: 10px 0; } 
  }

  .back-button { display: block; margin: 10px 20px 0; text-align: left; background-color: #2c3e50; color: white; padding: 10px 25px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; text-decoration: none; width: fit-content; }
  .back-button:hover { background-color: #34495e; }

  h1 { text-align: center; color: #2c3e50; font-size: 24px; margin-top: 20px; }

  .form-container { background: #2c3e50; color: white; max-width: 900px; margin: 20px auto; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
  .form-group { margin-bottom: 15px; }
  label { display: block; font-weight: bold; margin-bottom: 5px; }
  input { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; }

  .button-wrapper { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
  .button-wrapper button { background-color: #ffffff; color: #2c3e50; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; max-width: 150px; width: 100%; }
  .button-wrapper button:hover { background-color: #ddd; }

  .footer { background-color: #2c3e50; color: white; text-align: center; padding: 15px 20px; margin-top: 40px; }

  /* Special style for the top "Show Third Party Form" button */
  .top-button-wrapper {
    display: flex;
    justify-content: center;
    gap: 15px;  /* ‚¨ÖÔ∏è space between the two buttons */
    margin-top: 20px;
  }

  .edit-btn, .delete-btn {
  padding: 5px 10px;
  margin: 2px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.edit-btn {
  background-color: #4CAF50;
  color: white;
}

.delete-btn {
  background-color: #f44336;
  color: white;
}

#dateFilterWrapper {
  position: relative;
  z-index: 1;
}
#thirdPartyActions {
  position: relative;
  z-index: 2;
}


  .toggle-form-btn {
    background-color: #2c3e50;
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: background 0.3s;
  }

  .toggle-form-btn:hover {
    background-color: #34495e;
  }

  #thirdPartyDropdown {
  padding: 7px;
  border-radius: 6px;
  font-size: 18px;
  min-width: 200px;
  text-align: center; /* Centers the text in most browsers */
  text-align-last: center; /* Specifically for the selected option */
}

#jobOrderSummaryWrapper {
  display: block;
  margin: 20px auto;
  width: 100%;        /* wrapper takes full width */
  max-width: 100%;
  overflow-x: hidden; /* no sliding */
}

#jobOrderSummaryWrapper table.soa-table {
  width: 100%;        /* ‚úÖ table spans the whole page */
  max-width: 100%;
  table-layout: auto; /* let browser distribute space */
}

#jobOrderSummaryWrapper table {
  margin: 0 auto;            /* ensure the table itself is centered */
}

#soaMeasure {
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  background-color: #ffffff;
  color: rgb(0, 0, 0);
}

#soaMeasure option[disabled] {
  color: rgba(0, 0, 0, 0.5);
}
/* SOA Table Styles */o
.soa-table {
  width: 100%;
  margin: 0 auto;
  border-collapse: collapse;
  background: #fff;
  margin-top: 15px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);

  /* üîë Allow table to stretch naturally */
  table-layout: auto;
  min-width: 900px;  /* ensures it doesn‚Äôt collapse too much */
}

.soa-table th, 
.soa-table td {
  padding: 10px;
  border: 1px solid #ddd;
  font-size: 14px;
  text-align: center;
  vertical-align: middle;
  white-space: normal;      /* ‚úÖ allow wrapping */
  word-wrap: break-word;    /* ‚úÖ break long words */
  max-width: 150px;         /* ‚úÖ keep columns compact */
}

.soa-table th {
  background: #2c3e50;
  color: #fff;
  text-transform: uppercase;
  font-size: 13px;
  letter-spacing: 0.5px;
}
.soa-table td .edit-btn,
.soa-table td .delete-btn {
  display: inline-block;   /* keep them in-line */
  margin: 0 3px;           /* small horizontal spacing */
}

.soa-table tr:nth-child(even) {
  background: #f9f9f9;
}

.soa-table tfoot td {
  font-weight: bold;
  background: #ecf0f1;
  text-align: center !important;  /* ‚úÖ Force footer to center */
}

.soa-table td:last-child {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;   /* spacing between Edit and Delete */
}

/* Wrapper: horizontal layout */
#uploadWrapper {
  margin: 20px 0;
  display: flex;
  gap: 15px;
  flex-wrap: wrap; /* allows wrapping on smaller screens */
  justify-content: flex-start;
}

/* Upload blocks */
.excel-upload {
  flex: 1 1 20%;   /* shrink from 30% ‚Üí 20% */
  min-width: 200px; /* allow smaller width */
  max-width: 300px; /* prevent stretching */
  background: #f8f9fa;
  border: 1px solid #ddd;
  padding: 12px 15px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  transition: all 0.2s ease;
}

.excel-upload:hover {
  background: #f1f1f1;
  border-color: #bbb;
}

/* Labels */
.excel-upload label {
  font-weight: 600;
  margin-bottom: 8px;
  font-size: 14px;
  color: #333;
  display: block;
}

/* File input */
.excel-upload input[type="file"] {
  border: 1px solid #ccc;
  padding: 6px;
  border-radius: 5px;
  font-size: 13px;
  cursor: pointer;
  background: white;
  width: 100%;
}

.excel-upload input[type="file"]:hover {
  border-color: #888;
}

#uploadWrapper {
  margin: 20px 0;
  display: flex;
  gap: 15px;
  flex-wrap: wrap;         /* allow wrapping */
  justify-content: center; /* center horizontally */
}
#excelUploadsWrapper {
  display: flex;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap; /* allows wrapping on smaller screens */
  margin-top: 15px;
}

</style>

  <script>
  // ---------------- LOGIN ENFORCEMENT ----------------
  (function enforceLogin() {
  const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
  const userRole = localStorage.getItem("userRole");

  if (!isLoggedIn || (userRole !== "master" && userRole !== "logistics")) {
    // Show white background instantly
    document.documentElement.innerHTML = '<body style="background:#fff; margin:0"></body>';
    
    // Redirect to login
    window.location.replace("../../login.html");
  }
})();
</script>
</head>
<body>
<main>
<header>
<nav>
  <div class="nav-container">
    <div class="logo">RD8 BUILDERS CORP</div>
    <div class="menu-toggle" id="menu-toggle"><span></span><span></span><span></span></div>
    <div class="nav-links" id="nav-links">
      <a href="../../Index.html" class="nav-item">Home</a>
      <a href="../../AboutUs.html" class="nav-item">About Us</a>
      <a href="../../CompanyProfile.html" class="nav-item">Company Profile</a>
      <a href="../../ContactUs.html" class="nav-item">Contact Us</a>
      <a href="#" class="nav-item" id="authLink">Login</a>
    </div>
  </div>
</nav>
<a class="back-button" href="Logistics.html">‚Üê Back to Logistics</a>
</header>

<h1>3RD PARTY COLLECTION REPORT</h1>

<!-- Buttons -->
<div class="top-button-wrapper">
  <button class="toggle-form-btn" onclick="showThirdPartyForm()">Add 3rd Party</button>
  <button class="toggle-form-btn" onclick="generateThirdPartyRecord()">Generate Record</button>
</div>

<!-- Hidden form -->
<div id="thirdPartyFormWrapper" class="form-container" style="display:none;">
  <div class="form-group">
    <label>Company Name:</label>
    <input type="text" id="companyName">
  </div>
  <div class="form-group">
    <label>Purpose:</label>
    <input type="text" id="purpose">
  </div>

  <div class="button-wrapper">
    <button onclick="postThirdParty()">Submit</button>
    <button onclick="hideThirdPartyForm()">Hide Form</button>
  </div>
</div>

<!-- 3rd Party Table Wrapper -->
<div id="thirdPartyTableWrapper" style="display:none; max-width:900px; margin:20px auto; text-align:center;">
  <div>
    <label for="thirdPartyDropdown" style="font-weight:bold; display:block; margin-bottom:5px;">Choose 3rd Party:</label>
    <select id="thirdPartyDropdown" onchange="onChooseThirdParty()">
  <option value="">-- Select 3rd Party --</option>
</select>
  </div>

  <!-- Date Filter in its own wrapper below dropdown -->
  <div id="dateFilterWrapper" style="display:none; text-align:center; margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:6px; background:#f9f9f9; max-width:200px; margin-left:auto; margin-right:auto;">
    <label style="margin-right:5px;">From: <input type="date" id="filterStartDate" style="padding:5px; border-radius:4px;"></label>
    <label style="margin-right:5px;">To: <input type="date" id="filterEndDate" style="padding:5px; border-radius:4px;"></label>
    <button onclick="filterByDateRange()" style="padding:5px 12px; margin-right:5px; cursor:pointer; border-radius:4px; background:#2c3e50; color:white; border:none;">Filter</button>
    <button onclick="clearDateFilter()" style="padding:5px 12px; cursor:pointer; border-radius:4px; background:#e74c3c; color:white; border:none;">Clear</button>
  </div>

  <!-- Actions -->
  <div id="thirdPartyActions" style="margin-top:20px;"></div>
</div>

<!-- Job Order Form -->
<!-- SOA Form -->
<div id="soaFormWrapper" class="form-container" style="display:none;">
  <h2 style="text-align:center; margin-bottom:15px;">SOA Form</h2>

  <div class="form-group">
    <label>Date:</label>
    <input type="date" id="soaDate">
  </div>

  <div class="form-group">
    <label>Name of Operator:</label>
    <input type="text" id="soaOperator">
  </div>

  <div class="form-group">
    <label>Equipment Name:</label>
    <input type="text" id="soaEquipment">
  </div>

  <div class="form-group">
    <label>Duties:</label>
    <input type="text" id="soaDuties">
  </div>

  <div class="form-group">
    <label>Project Site:</label>
    <input type="text" id="soaProject">
  </div>

  <div class="form-group">
    <label for="soaMeasure">Select Measure:</label>
    <select id="soaMeasure" onchange="toggleFields()">
      <option value="HR">HR</option>
      <option value="DAY">Day</option>
      <option value="LOADS">Load/s</option>
</select>
  </div>

<!-- Hours -->
<div id="hoursField" class="form-group hidden">
  <label for="soaHours">Hours:</label>
  <input type="number" id="soaHours" placeholder="Enter hours">
</div>

<!-- Minutes -->
<div id="minutesField" class="form-group hidden">
  <label for="soaMinutes">Minutes:</label>
  <input type="number" id="soaMinutes" placeholder="Enter minutes">
</div>

<!-- Loads -->
<div id="loadsField" class="form-group hidden">
  <label for="soaLoads">No. of Loads:</label>
  <input type="number" id="soaLoads" placeholder="Enter loads">
</div>

<!-- Rental Fees -->
<div id="rentalField" class="form-group hidden">
  <label for="soaRentalFee">Rental Fees:</label>
  <input type="number" id="soaRentalFee" placeholder="Enter rental fees">
</div>

  <div class="button-wrapper">
    <button onclick="submitSOA()">Submit SOA</button>
    <button onclick="hideSOAForm()">Hide Form</button>
  </div>
</div>

<!-- Job Order Summary -->
<div id="jobOrderSummaryWrapper" style="width:80%; margin:10px auto; display:none;"></div>

<div id="excelUploadsWrapper" style="display:none;">
  <div class="excel-upload">
    <label>Upload DIESEL CONSUMPTION</label>
    <input type="file" id="dieselUpload" accept=".xlsx,.xls" onchange="handleExcelUpload(event,'diesel')">
  </div>

  <div class="excel-upload">
    <label>Upload PAYROLL</label>
    <input type="file" id="payrollUpload" accept=".xlsx,.xls" onchange="handleExcelUpload(event,'payroll')">
  </div>

  <div class="excel-upload">
    <label>Upload MAINTENANCE</label>
    <input type="file" id="maintenanceUpload" accept=".xlsx,.xls" onchange="handleExcelUpload(event,'maintenance')">
  </div>
</div>



<div id="downloadWrapper" style="text-align:center; margin-top:15px; display:none;">
  <button onclick="downloadSOATable()" class="toggle-form-btn">
    Download Excel
  </button>
</div>

<div id="uploadPreviewWrapper" style="margin-top:20px;"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>


let dieselTotal = 0;
let payrollTotal = 0;
let maintenanceTotal = 0;

function handleExcelUpload(event, type) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });

    // Get first sheet
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // --- Extract Grand Total directly ---
    // Assume "TOTAL" or "Grand Total" is in the first column
    let grandTotal = 0;
    for (let i = 0; i < json.length; i++) {
      const row = json[i];
      if (!row || row.length === 0) continue;
      const firstCell = String(row[0]).toLowerCase();
      if (firstCell.includes("total")) {
        const lastCell = row[row.length - 1];
        if (!isNaN(lastCell)) {
          grandTotal = lastCell;
          break;
        }
      }
    }

    // Save extracted grand total
    if (type === "diesel") dieselTotal = grandTotal;
    if (type === "payroll") payrollTotal = grandTotal;
    if (type === "maintenance") maintenanceTotal = grandTotal;

    document.getElementById("downloadWrapper").style.display = "block";
  };
  reader.readAsArrayBuffer(file);
}


  
let editingSOAId = null; // Track which SOA is being edited

document.addEventListener("click", function(e) {
  if (e.target.classList.contains("delete-btn")) {
    const id = e.target.getAttribute("data-id");
    // ‚ùå remove record by id
    console.log("Delete record:", id);
  }

  if (e.target.classList.contains("edit-btn")) {
    const id = e.target.getAttribute("data-id");
    // ‚úèÔ∏è open edit form or modal
    console.log("Edit record:", id);
  }
});




function handleThirdPartyChange() {
  const thirdParty = document.getElementById("thirdPartySelect").value;
  const wrapper = document.getElementById("jobOrderSummaryWrapper");

  // Reset summary area
  wrapper.innerHTML = "";
  wrapper.style.display = "none";

  // üëá Show date filter only when a valid 3rd party is selected
  if (thirdParty) {
    document.getElementById("dateFilterWrapper").style.display = "block";
  } else {
    document.getElementById("dateFilterWrapper").style.display = "none";
  }
}

function filterByDateRange() {
  const thirdParty = document.getElementById("thirdPartyDropdown").value;
  if (!thirdParty) return;

  const startDate = document.getElementById("filterStartDate").value;
  const endDate = document.getElementById("filterEndDate").value;

  let soaRecords = JSON.parse(localStorage.getItem("soaRecords")) || [];
  let filteredRecords = soaRecords.filter(r => r.thirdParty === thirdParty);

  if (startDate) {
    const from = new Date(startDate);
    filteredRecords = filteredRecords.filter(r => new Date(r.date) >= from);
  }
  if (endDate) {
    const to = new Date(endDate);
    filteredRecords = filteredRecords.filter(r => new Date(r.date) <= to);
  }

  // ‚úÖ generate new summary with filtered records
  generateSOASummaryForThirdParty(thirdParty, false, filteredRecords);

  // ‚úÖ recalc totals
  updateGrandTotalFromVisibleRows();
}

  function toggleFields() {
    const measure = document.getElementById("soaMeasure").value;

    const minutesField = document.getElementById("minutesField");
    const hoursField   = document.getElementById("hoursField");
    const loadsField   = document.getElementById("loadsField");
    const rentalField  = document.getElementById("rentalField");

    // Reset everything hidden
    minutesField.style.display = "none";
    hoursField.style.display = "none";
    loadsField.style.display = "none";
    rentalField.style.display = "none";

    if (measure === "HR") {
      minutesField.style.display = "block";
      hoursField.style.display = "block";
      rentalField.style.display = "block";
    } else if (measure === "DAY") {
      rentalField.style.display = "block";
    } else if (measure === "LOADS") {
      loadsField.style.display = "block";
      rentalField.style.display = "block";
    }
  }

  // Run once on page load
  window.onload = toggleFields;
  

function addRow(description, measure, loads, hours, minutes, rentalFee, amount) {
  const tableBody = document.getElementById("soaTableBody");
  const row = document.createElement("tr");

  // ‚úÖ Decide what goes into Total Time
  let totalTime = "-";
  if (measure === "HR") {
    const hr = hours ? `${hours}Hr` : "";
    const min = minutes ? `${minutes}Min` : "";
    totalTime = `${hr} ${min}`.trim() || "-";
  }

  // ‚úÖ Decide what goes into Loads column
  let loadsDisplay = (measure === "LOADS") ? loads : "-";

  row.innerHTML = `
    <td>${description}</td>
    <td>${measure}</td>
    <td>${loadsDisplay}</td>   <!-- ‚úÖ now displays in the new column -->
    <td>${totalTime}</td>
    <td>${rentalFee}</td>
    <td>${amount}</td>
  `;

  tableBody.appendChild(row);
}

function clearDateFilter() {
  document.getElementById("filterStartDate").value = "";
  document.getElementById("filterEndDate").value = "";

  const thirdParty = document.getElementById("thirdPartyDropdown").value;
  if (thirdParty) {
    generateSOASummaryForThirdParty(thirdParty);  // reload full records
    updateGrandTotalFromVisibleRows();            // recalc totals
  }
}


document.getElementById("soaMeasure").addEventListener("change", function() {
    const measure = this.value;
    const hoursField = document.getElementById("soaHours").parentElement;
    const minutesField = document.getElementById("soaMinutes").parentElement;

    if (measure === "DAY") {
        hoursField.style.display = "none";
        minutesField.style.display = "none";
        document.getElementById("soaHours").value = "";
        document.getElementById("soaMinutes").value = "";
    } else if (measure === "HR") {
        hoursField.style.display = "block";
        minutesField.style.display = "block";
    }
});

function showSOAForm() {
    document.getElementById("soaFormWrapper").style.display = "block";
    const measure = document.getElementById("soaMeasure").value;
    const hoursField = document.getElementById("soaHours").parentElement;
    const minutesField = document.getElementById("soaMinutes").parentElement;

    if (measure === "DAY") {
        hoursField.style.display = "none";
        minutesField.style.display = "none";
    } else {
        hoursField.style.display = "block";
        minutesField.style.display = "block";
    }
}

function hideSOAForm() {
  document.getElementById("soaFormWrapper").style.display = "none";
}
let thirdPartyList = JSON.parse(localStorage.getItem("thirdPartyList")) || [];
let jobOrders = JSON.parse(localStorage.getItem("jobOrders")) || [];
let filteredJobOrders = [];

function showThirdPartyForm(){document.getElementById("thirdPartyFormWrapper").style.display="block";}
function hideThirdPartyForm(){document.getElementById("thirdPartyFormWrapper").style.display="none";}

function postThirdParty(){
  const name=document.getElementById("companyName").value.trim();
  const purpose=document.getElementById("purpose").value.trim();
  if(!name){alert("Please enter a Company Name before submitting."); return;}
  const entry={name,purpose};
  thirdPartyList.push(entry);
  localStorage.setItem("thirdPartyList",JSON.stringify(thirdPartyList));
  alert("3rd Party saved: "+name);
  document.getElementById("companyName").value=""; document.getElementById("purpose").value="";
}

function onChooseThirdParty(){
  const dropdown = document.getElementById("thirdPartyDropdown");
  const selected = dropdown.value;

  const actionsDiv = document.getElementById("thirdPartyActions");
  const wrapper = document.getElementById("jobOrderSummaryWrapper");

  wrapper.innerHTML = "";
  wrapper.style.display = "none"; 
  actionsDiv.innerHTML = "";


  if(selected){
    const btnWrapper = document.createElement("div"); 
    btnWrapper.className = "top-button-wrapper";

    // Create "Create SOA" button
    const soaBtn = document.createElement("button");
    soaBtn.textContent = "Create SOA";
    soaBtn.className = "toggle-form-btn";
    soaBtn.onclick = () => showSOAForm();  

    // Create "Generate SOA Summary" button
    const summaryBtn = document.createElement("button");
    summaryBtn.textContent = "Generate SOA Summary";
    summaryBtn.className = "toggle-form-btn";
    summaryBtn.onclick = () => generateSOASummaryForThirdParty(selected);

    // Create "Delete 3rd Party" button
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete 3rd Party";
    deleteBtn.className = "toggle-form-btn";
    deleteBtn.style.backgroundColor = "#e74c3c";
    deleteBtn.style.color = "white";
    deleteBtn.onclick = () => deleteThirdParty(selected);

    // Create "Sort by Date" button
    const sortBtn = document.createElement("button");
    sortBtn.textContent = "Sort by Date";
    sortBtn.className = "toggle-form-btn";
    sortBtn.onclick = () => sortSOAByDate();


    btnWrapper.appendChild(soaBtn);
    btnWrapper.appendChild(summaryBtn);
    btnWrapper.appendChild(sortBtn);
    btnWrapper.appendChild(deleteBtn);

    actionsDiv.appendChild(btnWrapper);
  }
}


function sortSOAByDate() {
  const table = document.querySelector("#jobOrderSummaryWrapper table.soa-table");
  if (!table) return;

  const tbody = table.querySelector("tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));

  // Sort rows by data-date
  rows.sort((a, b) => {
    const dateA = new Date(a.getAttribute("data-date") || 0);
    const dateB = new Date(b.getAttribute("data-date") || 0);
    return dateA - dateB;
  });

  rows.forEach(row => tbody.appendChild(row));

  // ‚úÖ recalc totals
  updateGrandTotalFromVisibleRows();
}



function updateGrandTotalFromVisibleRows() {
  const table = document.querySelector("#jobOrderSummaryWrapper table.soa-table");
  if (!table) return;

  const rows = Array.from(table.querySelectorAll("tbody tr"));
  let grandTotal = 0;

  rows.forEach(row => {
    if (row.style.display !== "none") {
      const value = parseFloat(row.getAttribute("data-total")) || 0;
      grandTotal += value;
    }
  });

  // Update footer cell (always target last row of tfoot, last td)
  const footerCell = table.querySelector("tfoot td:nth-child(10)");
  if (footerCell) {
    footerCell.textContent = `‚Ç± ${grandTotal.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  }
}


function deleteThirdParty(name){
  if(confirm(`Are you sure you want to delete "${name}" and all its SOA records?`)){
    thirdPartyList=thirdPartyList.filter(tp=>tp.name!==name);
    localStorage.setItem("thirdPartyList",JSON.stringify(thirdPartyList));
    jobOrders=jobOrders.filter(order=>order.thirdParty!==name);
    localStorage.setItem("jobOrders",JSON.stringify(jobOrders));
    alert(`3rd Party "${name}" deleted successfully.`);
    generateThirdPartyRecord();
    document.getElementById("thirdPartyActions").innerHTML="";
    document.getElementById("jobOrderSummaryWrapper").style.display="none";
  }
}

function submitJobOrder(){
  const thirdParty=document.getElementById("thirdPartyDropdown").value;
  if(!thirdParty){alert("Please select a 3rd Party first."); return;}
  const orderNo=document.getElementById("jobOrderNo").value.trim();
  const details=document.getElementById("detailsOfRepair").value.trim();
  const started=document.getElementById("dateStarted").value;
  const completed=document.getElementById("dateCompleted").value;
  const cost=document.getElementById("totalCost").value;
  const spareParts=Array.from(document.getElementsByClassName("sparePart")).map(i=>i.value.trim()).filter(v=>v);
  if(!orderNo||!details||!started||!completed){alert("Please fill all required fields."); return;}
  const jobOrder={thirdParty,orderNo,details,started,completed,cost,spareParts};
  jobOrders.push(jobOrder);
  localStorage.setItem("jobOrders",JSON.stringify(jobOrders));
  alert(`Job Order ${orderNo} for ${thirdParty} saved successfully.`);
  document.getElementById("jobOrderNo").value=""; document.getElementById("detailsOfRepair").value=""; document.getElementById("dateStarted").value=""; document.getElementById("dateCompleted").value=""; document.getElementById("totalCost").value="";
  document.getElementById("sparePartsContainer").innerHTML=`<input type="text" class="sparePart" placeholder="Enter spare part">`;
  hideJobOrderForm(); generateJobOrderSummaryForThirdParty(thirdParty);
}

function generateJobOrderSummaryForThirdParty(thirdParty){
  const wrapper=document.getElementById("jobOrderSummaryWrapper"); wrapper.innerHTML="";
  if(!thirdParty) return;
  const orders=jobOrders.filter(o=>o.thirdParty===thirdParty);
  if(orders.length===0){wrapper.innerHTML=`<p style="text-align:center; font-weight:bold;">No job orders found for ${thirdParty}.</p>`; wrapper.style.display="block"; return;}
  let table=`<h3 style="text-align:center; margin-bottom:10px;">Job Orders for ${thirdParty}</h3><table style="width:100%; border-collapse:collapse; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.1); text-align:center;"><thead><tr style="background:#2c3e50; color:white;"><th style="padding:10px; border:1px solid #ddd;">Job Order No.</th><th style="padding:10px; border:1px solid #ddd;">Details</th><th style="padding:10px; border:1px solid #ddd;">Date Started</th><th style="padding:10px; border:1px solid #ddd;">Date Completed</th><th style="padding:10px; border:1px solid #ddd;">Spare Parts Used</th><th style="padding:10px; border:1px solid #ddd;">Cost</th><th style="padding:10px; border:1px solid #ddd;">Action</th></tr></thead><tbody>`;
  orders.forEach((order,index)=>{table+=`<tr><td style="padding:10px; border:1px solid #ddd;">${order.orderNo}</td><td style="padding:10px; border:1px solid #ddd;">${order.details}</td><td style="padding:10px; border:1px solid #ddd;">${order.started}</td><td style="padding:10px; border:1px solid #ddd;">${order.completed}</td><td style="padding:10px; border:1px solid #ddd;">${order.spareParts.join(", ")}</td><td style="padding:10px; border:1px solid #ddd;">‚Ç± ${order.cost}</td><td style="padding:10px; border:1px solid #ddd;"><button onclick="removeJobOrderForThirdParty('${thirdParty}',${index})" style="background:#e74c3c; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">Remove</button></td></tr>`;});
  table+="</tbody></table>"; wrapper.innerHTML=table; wrapper.style.display="block";
}

function removeJobOrderForThirdParty(thirdParty,index){
  if(confirm("Are you sure you want to delete this job order?")){
    let orders=jobOrders.filter(o=>o.thirdParty===thirdParty);
    const globalIndex=jobOrders.findIndex(o=>o.thirdParty===thirdParty&&o.orderNo===orders[index].orderNo);
    if(globalIndex>-1){jobOrders.splice(globalIndex,1); localStorage.setItem("jobOrders",JSON.stringify(jobOrders)); generateJobOrderSummaryForThirdParty(thirdParty);}
  }
}

function submitSOA() {
  const thirdParty = document.getElementById("thirdPartyDropdown").value;
  if (!thirdParty) { 
    alert("Select a 3rd Party first."); 
    return; 
  }

  const id = editingSOAId || Date.now(); // unique ID

  const soa = {
    id,
    date: document.getElementById("soaDate").value,
    operator: document.getElementById("soaOperator").value.trim(),
    equipment: document.getElementById("soaEquipment").value.trim(),
    duties: document.getElementById("soaDuties").value.trim(),
    project: document.getElementById("soaProject").value.trim(),
    measure: document.getElementById("soaMeasure").value,
    loads: document.getElementById("soaLoads").value,
    hours: document.getElementById("soaHours").value,
    minutes: document.getElementById("soaMinutes").value,
    loads: document.getElementById("soaLoads").value,   // ‚úÖ add loads
    rentalFee: document.getElementById("soaRentalFee").value,
    thirdParty
  };

  let soaRecords = JSON.parse(localStorage.getItem("soaRecords")) || [];

  if (editingSOAId) {
    soaRecords = soaRecords.map(r => r.id === editingSOAId ? soa : r);
    editingSOAId = null;
  } else {
    soaRecords.push(soa);
  }

  localStorage.setItem("soaRecords", JSON.stringify(soaRecords));

  alert(`SOA entry for ${thirdParty} saved successfully.`);

  // ‚úÖ Reset
  document.querySelectorAll("#soaFormWrapper input").forEach(el => el.value = "");
  document.getElementById("soaMeasure").selectedIndex = 0;

  hideSOAForm();
  generateSOASummaryForThirdParty(thirdParty);
}


function generateThirdPartyRecord() {
  const wrapper = document.getElementById("thirdPartyTableWrapper");
  const dropdown = document.getElementById("thirdPartyDropdown");

  // Always show wrapper
  wrapper.style.display = "block";

  // Clear dropdown
  dropdown.innerHTML = '<option value="">-- Select 3rd Party --</option>';

  // Load from localStorage
  let thirdPartyList = JSON.parse(localStorage.getItem("thirdPartyList")) || [];

  if (thirdPartyList.length === 0) {
    alert("No 3rd Party records found. Please add one first.");
    return;
  }

  // Populate dropdown
  thirdPartyList.forEach(tp => {
    const opt = document.createElement("option");
    opt.value = tp.name;
    opt.textContent = tp.name;
    dropdown.appendChild(opt);
  });

  // Automatically select the first one and trigger the button creation
  if (thirdPartyList.length > 0) {
    dropdown.selectedIndex = 1; // selects the first added 3rd party
    onChooseThirdParty();
  }
}




function deleteSOA(id, thirdParty) {
  if (!confirm("Are you sure you want to delete this SOA record?")) return;
  let soaRecords = JSON.parse(localStorage.getItem("soaRecords")) || [];
  soaRecords = soaRecords.filter(r => r.id !== id);
  localStorage.setItem("soaRecords", JSON.stringify(soaRecords));
  generateSOASummaryForThirdParty(thirdParty);
}


// ‚úÖ Edit SOA (load into form)
function editSOA(id) {
  let soaRecords = JSON.parse(localStorage.getItem("soaRecords")) || [];
  const record = soaRecords.find(r => r.id === id);
  if (!record) return;

  editingSOAId = id;

  document.getElementById("soaDate").value = record.date;
  document.getElementById("soaOperator").value = record.operator;
  document.getElementById("soaEquipment").value = record.equipment;
  document.getElementById("soaDuties").value = record.duties;
  document.getElementById("soaProject").value = record.project;
  document.getElementById("soaMeasure").value = record.measure;
  document.getElementById("soaHours").value = record.hours;
  document.getElementById("soaMinutes").value = record.minutes;
  document.getElementById("soaRentalFee").value = record.rentalFee;

  showSOAForm();
}


function generateSOASummaryForThirdParty(thirdParty, sortByDate = false, records = null) {
  document.getElementById("dateFilterWrapper").style.display = "block";
  document.getElementById("excelUploadsWrapper").style.display = "flex"; // ‚úÖ show Excel uploads
  const wrapper = document.getElementById("jobOrderSummaryWrapper");
  wrapper.innerHTML = "";

  let soaRecords = JSON.parse(localStorage.getItem("soaRecords")) || [];
  let companyRecords = records || soaRecords.filter(r => r.thirdParty === thirdParty);

  if (sortByDate) {
    companyRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
  }

  if (companyRecords.length === 0) {
    wrapper.innerHTML = `<p style="text-align:center; font-weight:bold;">No SOA records found for ${thirdParty}.</p>`;
    wrapper.style.display = "block";
    return;
  }

  // --- DATE RANGE HEADER ---
  const startDate = document.getElementById("filterStartDate").value;
  const endDate = document.getElementById("filterEndDate").value;

  let dateRange = "";
  if (startDate && endDate) {
    const dStart = new Date(startDate);
    const dEnd = new Date(endDate);

    if (dStart.getMonth() === dEnd.getMonth() && dStart.getFullYear() === dEnd.getFullYear()) {
      const month = dStart.toLocaleDateString("en-US", { month: "long" });
      dateRange = `${month} ${dStart.getDate()}-${dEnd.getDate()}, ${dStart.getFullYear()}`;
    } else {
      const formatDate = d => d.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
      dateRange = `${formatDate(dStart)} - ${formatDate(dEnd)}`;
    }
  } else if (startDate) {
    const dStart = new Date(startDate);
    dateRange = dStart.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
  } else if (endDate) {
    const dEnd = new Date(endDate);
    dateRange = dEnd.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
  }

  // --- Build table header ---
  let table = `
    <h3 style="text-align:center; margin-bottom:5px;">SOA Records for ${thirdParty}</h3>
    <h4 style="text-align:center; margin-bottom:15px;">${dateRange || ""}</h4>
    <table class="soa-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Operator</th>
          <th>Equipment</th>
          <th>Duties</th>
          <th>Project</th>
          <th>Measure</th>
          <th>No. of Loads</th>
          <th>Total Time</th>
          <th>Rental Fee</th>
          <th>Total Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
  `;

  let grandTotal = 0;

  companyRecords.forEach(record => {
    const hrs = record.hours ? `${record.hours}hr${record.hours > 1 ? "s" : ""}` : "";
    const mins = record.minutes ? `${record.minutes} min${record.minutes > 1 ? "s" : ""}` : "";
    const totalTime = hrs && mins ? `${hrs} & ${mins}` : hrs || mins || "-";

    const loadsDisplay = (record.measure === "LOADS") ? record.loads || "0" : "-";
    const rentalFee = parseFloat(record.rentalFee) || 0;
    let totalAmount = rentalFee;

    if (record.measure === "HR") {
      const hours = parseFloat(record.hours) || 0;
      const minutes = parseFloat(record.minutes) || 0;
      const totalHours = hours + minutes / 60;
      totalAmount = rentalFee * totalHours;
    } else if (record.measure === "DAY") {
      totalAmount = rentalFee;
    } else if (record.measure === "LOADS") {
      const loads = parseFloat(record.loads) || 0;
      totalAmount = rentalFee * loads;
    }

    grandTotal += totalAmount;

    // Format date
    let formattedDate = "";
    if (record.date) {
      const d = new Date(record.date);
      const day = String(d.getDate()).padStart(2, "0");
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const year = d.getFullYear();
      formattedDate = `${day}/${month}/${year}`;
    }

    table += `
      <tr data-date="${record.date}" data-total="${totalAmount}">
        <td>${formattedDate}</td>
        <td>${record.operator}</td>
        <td>${record.equipment}</td>
        <td>${record.duties}</td>
        <td>${record.project}</td>
        <td>${record.measure}</td>
        <td>${loadsDisplay}</td>
        <td>${totalTime}</td>
        <td>‚Ç± ${rentalFee.toLocaleString("en-US", { minimumFractionDigits: 2 })}</td>
        <td>‚Ç± ${totalAmount.toLocaleString("en-US", { minimumFractionDigits: 2 })}</td>
        <td>
          <button class="edit-btn" onclick="editSOA(${record.id})">Edit</button>
          <button class="delete-btn" onclick="deleteSOA(${record.id}, '${thirdParty}')">Delete</button>
        </td>
      </tr>
    `;
  });

  table += `
      </tbody>
      <tfoot>
        <tr>
          <td colspan="9" style="text-align:right; font-weight:bold;">Grand Total:</td>
          <td colspan="2" style="font-weight:bold; text-align:center;">‚Ç± ${grandTotal.toLocaleString("en-US", { minimumFractionDigits: 2 })}</td>
        </tr>
      </tfoot>
    </table>
  `;

  wrapper.innerHTML = table;
  wrapper.style.display = "block";
  document.getElementById("downloadWrapper").style.display = "block";
  
}




function downloadSOATable() {
  const thirdParty = document.getElementById("thirdPartyDropdown").value;
  if (!thirdParty) {
    alert("Select a 3rd Party first.");
    return;
  }

  const thirdPartyList = JSON.parse(localStorage.getItem("thirdPartyList")) || [];
  const selectedTP = thirdPartyList.find(tp => tp.name === thirdParty);
  const purpose = selectedTP ? selectedTP.purpose : "(Purpose)";

  let soaRecords = JSON.parse(localStorage.getItem("soaRecords")) || [];
  let companyRecords = soaRecords.filter(r => r.thirdParty === thirdParty);

  // Apply date filter if any
  const startDate = document.getElementById("filterStartDate").value;
  const endDate = document.getElementById("filterEndDate").value;
  if (startDate || endDate) {
    const from = startDate ? new Date(startDate) : null;
    const to = endDate ? new Date(endDate) : null;
    companyRecords = companyRecords.filter(record => {
      const d = new Date(record.date);
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    });
  }

  if (companyRecords.length === 0) {
    alert("No SOA records found for this 3rd Party after applying the filter.");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws_data = [];

  // --- Header rows ---
  ws_data.push(["STATEMENT OF ACCOUNT"]);
  ws_data.push(["Equipment Rental"]);
  ws_data.push([thirdParty.toUpperCase()]);
  ws_data.push([`Period: ${startDate || "N/A"} - ${endDate || "N/A"}`]);
  ws_data.push([`${purpose}`]);
  ws_data.push([]);
  ws_data.push(["Date", "Operator", "Equipment", "Duties", "Project Site", "No. of Loads", "Rental Fee (‚Ç±)", "Total Amount (‚Ç±)"]);

  // Add SOA records
  let grandTotal = 0;
  companyRecords.forEach(record => {
  const d = new Date(record.date);
  const formattedDate = `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;

  const rentalFee = parseFloat(record.rentalFee) || 0;
  let totalAmount = rentalFee;

  if (record.measure === "HR") {
    const hours = parseFloat(record.hours) || 0;
    const minutes = parseFloat(record.minutes) || 0;
    const totalHours = hours + minutes / 60;
    totalAmount = rentalFee * totalHours;
  } else if (record.measure === "DAY") {
    totalAmount = rentalFee;
  } else if (record.measure === "LOADS") {
    const loads = parseFloat(record.loads) || 0;
    totalAmount = rentalFee * loads;
  }

  grandTotal += totalAmount;

  // Format numbers with commas
  const rentalFeeFormatted = rentalFee.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const totalAmountFormatted = totalAmount.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  ws_data.push([
    formattedDate,
    record.operator,
    record.equipment,
    record.duties,
    record.project,
    record.measure === "LOADS" ? (record.loads || 0) : "-", // Loads
    rentalFeeFormatted,
    totalAmountFormatted
  ]);
});

 // Add diesel, payroll, maintenance totals dynamically
ws_data.push([]);
ws_data.push(["", "", "", "", "", "", "Grand Total", grandTotal]);
ws_data.push([]);
ws_data.push(["TOTAL AMOUNT OF RENTALS EQUIPMENT" , "", grandTotal]);
ws_data.push(["DIRECT COST"]);
ws_data.push(["DIESEL CONSUMPTION", "", dieselTotal]);
ws_data.push(["PAYROLL", "", payrollTotal]);
ws_data.push(["MAINTENANCE", "", maintenanceTotal]);


// Add a total of totals
const totalDirectCost = dieselTotal + payrollTotal + maintenanceTotal;
ws_data.push(["TOTAL", "", totalDirectCost]);

ws_data.push(["NET PAYMENT", "", grandTotal - totalDirectCost]);

ws_data.push([]); // empty row


  ws_data.push([]);
  ws_data.push([]);
  ws_data.push(["Prepared by:", "", "Noted by:", "", "Approved by:", "", "Received by:"]);
  ws_data.push([]);
  ws_data.push(["ANGELIKA C. CASTILLO", "", "ROAN MAICO DE GUZMAN", "", "RAMPEL LUIS P. DE GUZMAN", "", thirdParty]);
  ws_data.push(["Admin Staff", "", "Logistics & Equipment Manager", "", "President", "", ""]);


    // Convert array to worksheet
  const ws = XLSX.utils.aoa_to_sheet(ws_data);

  ws["!cols"] = [
  { wch: 12 }, // Column A: Date
  { wch: 22 }, // Column B: Operator
  { wch: 25 }, // Column C: Equipment
  { wch: 25 }, // Column D: Duties
  { wch: 25 }, // Column E: Project
  { wch: 18 }, // Column F: Rental Fee
  { wch: 18 }, // Column G: Total Amount
  { wch: 18 }, // Column H: Space
];

  // Merge header rows & signature labels
  ws["!merges"] = [
    { s: { r: 0, c: 0 }, e: { r: 0, c: 8 } },
    { s: { r: 1, c: 0 }, e: { r: 1, c: 8 } },
    { s: { r: 2, c: 0 }, e: { r: 2, c: 8 } },
    { s: { r: 3, c: 0 }, e: { r: 3, c: 8 } },
    { s: { r: 4, c: 0 }, e: { r: 4, c: 8 } },
    { s: { r: ws_data.length - 3, c: 0 }, e: { r: ws_data.length - 3, c: 1 } },
    { s: { r: ws_data.length - 3, c: 2 }, e: { r: ws_data.length - 3, c: 3 } },
    { s: { r: ws_data.length - 3, c: 4 }, e: { r: ws_data.length - 3, c: 5 } },
    { s: { r: ws_data.length - 3, c: 6 }, e: { r: ws_data.length - 3, c: 7 } },
    { s: { r: ws_data.length - 2, c: 0 }, e: { r: ws_data.length - 2, c: 1 } },
    { s: { r: ws_data.length - 2, c: 2 }, e: { r: ws_data.length - 2, c: 3 } },
    { s: { r: ws_data.length - 2, c: 4 }, e: { r: ws_data.length - 2, c: 5 } },
    { s: { r: ws_data.length - 2, c: 6 }, e: { r: ws_data.length - 2, c: 7 } },
    { s: { r: ws_data.length - 1, c: 0 }, e: { r: ws_data.length - 1, c: 1 } },
    { s: { r: ws_data.length - 1, c: 2 }, e: { r: ws_data.length - 1, c: 3 } },
    { s: { r: ws_data.length - 1, c: 4 }, e: { r: ws_data.length - 1, c: 5 } }
  ];

  XLSX.utils.book_append_sheet(wb, ws, "SOA");
  XLSX.writeFile(wb, `${thirdParty}_SOA.xlsx`);
}





window.onload=()=>{ const authLink=document.getElementById("authLink"); const isLoggedIn=localStorage.getItem("isLoggedIn")==="true"; if(isLoggedIn){ authLink.textContent="Logout"; authLink.onclick=()=>{if(confirm("Logout?")){localStorage.removeItem("isLoggedIn");window.location.href="../../login.html";}}}else{ authLink.textContent="Login"; authLink.onclick=()=>{window.location.href="../../login.html";} }};
</script>
</main>
<footer class="footer">
<p>&copy; Kurth Clarenze Lacsinto Novesteras. All rights reserved.</p>
</footer>
</body>
</html>
