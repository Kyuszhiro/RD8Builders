<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RMES</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; display: flex; flex-direction: column; font-family: 'Montserrat', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
    main { flex: 1; }
    nav { background-color: #2c3e50; padding: 15px 25px; color: white; }
    .nav-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .logo { font-size: 20px; font-weight: 700; color: white; }
    .nav-links { display: flex; flex-wrap: wrap; gap: 15px; }
    .nav-item, .nav-item-button { color: white; text-decoration: none; font-size: 16px; padding: 10px 15px; background: none; border: none; border-radius: 6px; cursor: pointer; }
    .nav-item:hover, .nav-item-button:hover { background-color: white; color: #2c3e50; }
    .menu-toggle { display: none; flex-direction: column; cursor: pointer; margin-left: auto; gap: 4px; }
    .menu-toggle span { height: 3px; width: 25px; background: white; border-radius: 3px; }
    .nav-links.show { display: flex; flex-direction: column; width: 100%; margin-top: 10px; }
    @media (max-width: 768px) { .menu-toggle { display: flex; } .nav-links { display: none; flex-direction: column; width: 100%; margin-top: 10px; } .nav-item { width: 100%; padding: 10px 0; } }
    .back-button { display: block; margin: 10px 20px 0; text-align: left; background-color: #2c3e50; color: white; padding: 10px 25px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; text-decoration: none; width: fit-content; }
    .back-button:hover { background-color: #34495e; }
    h1 { text-align: center; color: #2c3e50; font-size: 24px; margin-top: 20px; }
    .form-container { background: #2c3e50; color: white; max-width: 800px; margin: 20px auto; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; }
    .button-wrapper { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    .button-wrapper button { background-color: #ffffff; color: #2c3e50; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; max-width: 150px; width: 100%; }
    .button-wrapper button:hover { background-color: #ddd; }
    .table-wrapper { overflow-x: auto; overflow-y: auto; margin: 30px auto; max-width: 1300px; max-height: 500px; border: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; background-color: white; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; font-size: 14px; }
    th { background-color: #2c3e50; color: white; }
    td[contenteditable="true"] { background-color: white; }
    td.editing { outline: 2px solid #3498db; }
    .footer { background-color: #2c3e50; color: white; text-align: center; padding: 15px 20px; margin-top: 40px; }
    input:disabled, button:disabled { background-color: #ccc; color: #555; cursor: not-allowed; opacity: 0.6; }
    .sort-button { background-color: #2c3e50; color: white; border: none; border-radius: 6px; padding: 8px 15px; cursor: pointer; margin: 0 5px; transition: transform 0.1s, background-color 0.2s; }
    .sort-button:hover { background-color: #34495e; }
    .sort-button:active { transform: scale(0.95); background-color: #1f2d3a; }
    #filtersContainer input[type="date"] {
  width: 150px;         /* same as original form input width */
  padding: 10px;        /* matches original input padding */
  border: none;          /* removes default browser border */
  border-radius: 6px;    /* matches original input border-radius */
  font-size: 14px;       /* same font size */
  background-color: white; /* original white background */
  color: #2c3e50;        /* text color same as form inputs */
}
#filtersContainer label {
  font-weight: bold;
  margin-right: 10px;
}

    
  </style>

  <script>
  // ---------------- LOGIN ENFORCEMENT ----------------
  (function enforceLogin() {
  const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
  const userRole = localStorage.getItem("userRole");

  if (!isLoggedIn || (userRole !== "master" && userRole !== "logistics")) {
    // Show white background instantly
    document.documentElement.innerHTML = '<body style="background:#fff; margin:0"></body>';
    
    // Redirect to login
    window.location.replace("../../login.html");
  }
})();
</script>
</head>
<body>
<main>
<header>
<nav>
  <div class="nav-container">
    <div class="logo">RD8 BUILDERS CORP</div>
    <div class="menu-toggle" id="menu-toggle"><span></span><span></span><span></span></div>
    <div class="nav-links" id="nav-links">
      <a href="../../Index.html" class="nav-item">Home</a>
      <a href="../../AboutUs.html" class="nav-item">About Us</a>
      <a href="../../CompanyProfile.html" class="nav-item">Company Profile</a>
      <a href="../../ContactUs.html" class="nav-item">Contact Us</a>
      <a href="#" class="nav-item" id="authLink">Login</a>
    </div>
  </div>
</nav>
<a class="back-button" href="Logistics.html">← Back to Logistics</a>
</header>

<h1>REPAIR & MAINTENANCE EXPENSE SUMMARY</h1>

<div class="form-container">
  <div class="form-group"><label>Date:</label><input type="date" id="date"></div>
  <div class="form-group"><label>RFP / PCF No.:</label><input type="text" id="rfp"></div>
  <div class="form-group"><label>Equipment Code:</label><input type="text" id="equipmentCode"></div>
  <div class="form-group">
  <label>Description(s):</label>
  <div id="descriptionContainer">
    <input type="text" class="description-input" placeholder="Description 1">
  </div>
  <button type="button" onclick="addDescription()" style="
    margin-top: 5px;
    background-color: #3498db;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
  ">+ Add Description</button>
</div>

  <div class="form-group"><label>Amount:</label><input type="number" id="amount"></div>

  <div class="button-wrapper">
    <button onclick="postDetails()">Submit</button>
    <button onclick="toggleEditMode()">Edit Mode</button>
  </div>
</div>

<div id="filtersContainer" style="text-align: center; margin: 20px;">
  <label>From: <input type="date" id="fromDate"></label>
  <label>To: <input type="date" id="toDate"></label>
  <button onclick="downloadExcel()" style="
    background-color: #2c3e50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
  ">Download Excel</button>
</div>

<div style="text-align:center; margin: 20px;">
  <button class="sort-button" onclick="sortBy('date')">Sort by Date</button>
  <button class="sort-button" onclick="sortBy('rfp')">Sort by RFP / PCF No.</button>
  <button class="sort-button" onclick="sortBy('equipmentCode')">Sort by Equipment Code</button>
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>RFP / PCF No.</th>
        <th>Equipment Code</th>
        <th>Description</th>
        <th>Amount</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

<div style="text-align:center; margin: 20px;">
  <button onclick="generateSummary()" style="
    background-color: #27ae60;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
  ">Generate Summary Report</button>
</div>

<div class="table-wrapper" id="summaryWrapper" style="display:none;">
  <h2 style="text-align:center; color:#2c3e50;">Summary Report</h2>
  <table id="summaryTable">
    <thead>
      <tr>
        <th>Equipment Code</th>
        <th>Total Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th>Grand Total</th>
        <th id="grandTotal"></th>
      </tr>
    </tfoot>
  </table>
</div>

<div style="text-align:center; margin: 10px;">
  <button id="downloadSummaryBtn" onclick="downloadSummary()" style="
    background-color: #2980b9;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    display: none;  /* hidden by default */
  ">Download Summary Report</button>
</div>

</main>

<footer class="footer">
  <p>&copy; Kurth Clarenze Lacsinto Novesteras. All rights reserved.</p>
</footer>

<script>

  let entries = JSON.parse(localStorage.getItem("equipmentEntries") || "[]");
  let editingEnabled = false;

  let sortOrder = { date: true, rfp: true, equipmentCode: true }; // only three sortable fields

  function addDescription() {
  const container = document.getElementById("descriptionContainer");
  const currentCount = container.children.length;
  if (currentCount >= 5) {
    alert("Maximum of 5 descriptions allowed.");
    return;
  }
  const input = document.createElement("input");
  input.type = "text";
  input.className = "description-input";
  input.placeholder = "Description " + (currentCount + 1);
  input.style.marginTop = "5px";
  container.appendChild(input);
}


  function sortBy(field){
    entries.sort((a,b)=>{
      let valA = a[field].toLowerCase ? a[field].toLowerCase() : a[field];
      let valB = b[field].toLowerCase ? b[field].toLowerCase() : b[field];
      if(valA < valB) return sortOrder[field] ? -1 : 1;
      if(valA > valB) return sortOrder[field] ? 1 : -1;
      return 0;
    });
    sortOrder[field] = !sortOrder[field]; // toggle ascending/descending
    updateTable();
  }

  function save(){ localStorage.setItem("equipmentEntries", JSON.stringify(entries)); }

  function postDetails() {
  const descriptions = Array.from(document.querySelectorAll(".description-input"))
                            .map(i => i.value.trim())
                            .filter(i => i);
  
  const entry = {
  date: date.value,
  rfp: rfp.value,
  equipmentCode: equipmentCode.value,
  description: descriptions, // array of multiple descriptions
  amount: amount.value
};


  if(!entry.date || !entry.rfp || !entry.equipmentCode) {
    alert("Fill all required fields");
    return;
  }
  
  entries.push(entry);
  save();
  updateTable();

  // Reset inputs
  date.value = "";
  rfp.value = "";
  equipmentCode.value = "";
  amount.value = "";
  const container = document.getElementById("descriptionContainer");
  container.innerHTML = '<input type="text" class="description-input" placeholder="Description 1">';
}



  function updateTable(){
    const body = document.getElementById("dataBody");
    body.innerHTML = "";
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    const filteredEntries = entries.filter(e => {
      if(!from && !to) return true;
      const entryDate = e.date;
      if(from && entryDate < from) return false;
      if(to && entryDate > to) return false;
      return true;
    });

    filteredEntries.forEach((e,i)=>{
      const row = document.createElement("tr");
      ["date","rfp","equipmentCode","description","amount"].forEach(key => {
  const td = document.createElement("td");

  let value = e[key];
if (Array.isArray(value)) {
  // Join multiple descriptions with <br> so each appears on a new line in the table
  td.innerHTML = value.map(v => v.trim()).join("<br>");
} else {
  td.textContent = value;
}

  if (editingEnabled) {
    td.contentEditable = true;
    td.classList.add("editing");
    td.oninput = () => { 
      // If editing, split lines back into array for description
      if (key === "description") {
        entries[i][key] = td.innerText.split("\n").map(v => v.trim());
      } else {
        entries[i][key] = td.textContent;
      }
      save(); 
    };
  }

  row.appendChild(td);
});



      const td = document.createElement("td");
      const btn = document.createElement("button");
      btn.textContent = "Remove";
      btn.style.background = "#e74c3c"; 
      btn.style.color = "white"; 
      btn.style.border = "none"; 
      btn.style.padding = "5px 10px"; 
      btn.style.borderRadius = "4px";
      btn.onclick = () => { entries.splice(i,1); save(); updateTable(); };
      td.appendChild(btn);
      row.appendChild(td);

      body.appendChild(row);
    });
  }

  function sortBy(field){
    entries.sort((a,b)=>{
      let valA = a[field].toLowerCase ? a[field].toLowerCase() : a[field];
      let valB = b[field].toLowerCase ? b[field].toLowerCase() : b[field];
      if(valA < valB) return sortOrder[field] ? -1 : 1;
      if(valA > valB) return sortOrder[field] ? 1 : -1;
      return 0;
    });
    sortOrder[field] = !sortOrder[field];
    updateTable();
  }

  function toggleEditMode(){ editingEnabled = !editingEnabled; updateTable(); }

  function downloadExcel() {
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const filteredEntries = entries.filter(e => {
    if (!from && !to) return true;
    if (from && e.date < from) return false;
    if (to && e.date > to) return false;
    return true;
  });

  // Prepare worksheet data
  const ws_data = [
    ["Date","RFP / PCF No.","Equipment Code","Description","Amount"]
  ];

  filteredEntries.forEach(e => {
    const desc = Array.isArray(e.description) ? e.description.join("\n") : e.description;
    ws_data.push([e.date, e.rfp, e.equipmentCode, desc, parseFloat(e.amount)]);
  });

  // Create workbook
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);

  // Set column widths
  ws["!cols"] = [
    { wch: 15 },  // Date
    { wch: 15 },  // RFP / PCF No.
    { wch: 35 },  // Equipment Code
    { wch: 35 },  // Description (wider)
    { wch: 15 }   // Amount
  ];

  XLSX.utils.book_append_sheet(wb, ws, "Equipment Records");
  XLSX.writeFile(wb, "equipment_records.xlsx");
}



  document.getElementById("fromDate").addEventListener("change", updateTable);
  document.getElementById("toDate").addEventListener("change", updateTable);

  const authLink = document.getElementById("authLink");
  const menuToggle = document.getElementById("menu-toggle");
  const navLinks = document.getElementById("nav-links");

  menuToggle.addEventListener("click", () => { navLinks.classList.toggle("show"); });

  function updateAuthUI() {
    const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
    if (isLoggedIn) {
      authLink.textContent = "Logout";
      authLink.onclick = () => { if(confirm("Are you sure you want to logout?")) { localStorage.removeItem("isLoggedIn"); window.location.href = "../../login.html"; } };
    } else { authLink.textContent = "Login"; authLink.onclick = () => { window.location.href = "../../login.html"; }; }
  }

  function disableInteraction() {
    document.querySelectorAll("input, button").forEach(el => { el.disabled = true; el.style.cursor = "not-allowed"; });
    editingEnabled = false;
    updateTable();
  }

  window.onload = () => { updateTable(); updateAuthUI(); if(localStorage.getItem("isLoggedIn")!=="true"){ disableInteraction(); } };

  function generateSummary() {
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  // Filter entries by date
  const filteredEntries = entries.filter(e => {
    if (!from && !to) return true;
    if (from && e.date < from) return false;
    if (to && e.date > to) return false;
    return true;
  });

  const summaryWrapper = document.getElementById("summaryWrapper");
  const tbody = document.querySelector("#summaryTable tbody");
  tbody.innerHTML = ""; // clear previous summary

  // Aggregate totals by equipmentCode
  const totals = {};
  filteredEntries.forEach(entry => {
    const code = entry.equipmentCode;
    const amount = parseFloat(entry.amount) || 0;
    if (totals[code]) totals[code] += amount;
    else totals[code] = amount;
  });

  let grandTotal = 0;
  for (const [code, total] of Object.entries(totals)) {
    const tr = document.createElement("tr");
    const tdCode = document.createElement("td");
    tdCode.textContent = code;
    const tdAmount = document.createElement("td");
    tdAmount.textContent = total.toFixed(2);
    tr.appendChild(tdCode);
    tr.appendChild(tdAmount);
    tbody.appendChild(tr);

    grandTotal += total;
  }

  document.getElementById("grandTotal").textContent = grandTotal.toFixed(2);
  summaryWrapper.style.display = "block";

  // Show the download button
  document.getElementById("downloadSummaryBtn").style.display = "inline-block";
}


function downloadSummary() {
  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  // Filter entries by date
  const filteredEntries = entries.filter(e => {
    if (!from && !to) return true;
    if (from && e.date < from) return false;
    if (to && e.date > to) return false;
    return true;
  });

  // Prepare detailed worksheet data
  const ws_data = [
    ["Date","RFP / PCF No.","Equipment Code","Description","Amount"]
  ];

  let runningTotal = 0;
  filteredEntries.forEach(e => {
    const desc = Array.isArray(e.description) ? e.description.join("\n") : e.description;
    const amt = parseFloat(e.amount) || 0;
    ws_data.push([e.date, e.rfp, e.equipmentCode, desc, amt]);
    runningTotal += amt;
  });

  // ✅ Add empty row + Grand Total aligned under Amount column
  ws_data.push(["", "", "", "Grand Total", runningTotal]);

  // Add another empty row before the summary section
  ws_data.push([]);

  // Generate summary totals
  const totals = {};
  filteredEntries.forEach(entry => {
    const code = entry.equipmentCode;
    const amount = parseFloat(entry.amount) || 0;
    totals[code] = (totals[code] || 0) + amount;
  });

  ws_data.push(["Repair and Maintenance Expense Summary"]);
  ws_data.push(["Equipment Code","Total Amount"]);

  let grandTotal = 0;
  for (const [code, total] of Object.entries(totals)) {
    ws_data.push([code, total]);
    grandTotal += total;
  }

  // ✅ Grand Total for the summary section, also under Total Amount
  ws_data.push(["Grand Total", grandTotal]);

  // Create workbook and worksheet
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);

  // Set column widths
  ws["!cols"] = [
    { wch: 15 },  // Date
    { wch: 20 },  // RFP / PCF No.
    { wch: 25 },  // Equipment Code
    { wch: 40 },  // Description
    { wch: 15 }   // Amount / Total
  ];

  XLSX.utils.book_append_sheet(wb, ws, "Summary Report");
  XLSX.writeFile(wb, "equipment_summary_report.xlsx");
}



</script>
</body>
</html>
