<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Equipment History Record</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
  /* Core styles */
  * { box-sizing: border-box; }
  html, body { height: 100%; display: flex; flex-direction: column; font-family: 'Montserrat', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
  main { flex: 1; }

  nav { background-color: #2c3e50; padding: 15px 25px; color: white; }
  .nav-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
  .logo { font-size: 20px; font-weight: 700; color: white; }
  .nav-links { display: flex; flex-wrap: wrap; gap: 15px; }
  .nav-item { color: white; text-decoration: none; font-size: 16px; padding: 10px 15px; background: none; border: none; border-radius: 6px; cursor: pointer; }
  .nav-item:hover { background-color: white; color: #2c3e50; }
  .menu-toggle { display: none; flex-direction: column; cursor: pointer; margin-left: auto; gap: 4px; }
  .menu-toggle span { height: 3px; width: 25px; background: white; border-radius: 3px; }
  .nav-links.show { display: flex; flex-direction: column; width: 100%; margin-top: 10px; }
  @media (max-width: 768px) { 
    .menu-toggle { display: flex; } 
    .nav-links { display: none; flex-direction: column; width: 100%; margin-top: 10px; } 
    .nav-item { width: 100%; padding: 10px 0; } 
  }

  .back-button { display: block; margin: 10px 20px 0; text-align: left; background-color: #2c3e50; color: white; padding: 10px 25px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; text-decoration: none; width: fit-content; }
  .back-button:hover { background-color: #34495e; }

  h1 { text-align: center; color: #2c3e50; font-size: 24px; margin-top: 20px; }

  .form-container { background: #2c3e50; color: white; max-width: 900px; margin: 20px auto; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
  .form-group { margin-bottom: 15px; }
  label { display: block; font-weight: bold; margin-bottom: 5px; }
  input { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; }

  .button-wrapper { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
  .button-wrapper button { background-color: #ffffff; color: #2c3e50; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; max-width: 150px; width: 100%; }
  .button-wrapper button:hover { background-color: #ddd; }

  .footer { background-color: #2c3e50; color: white; text-align: center; padding: 15px 20px; margin-top: 40px; }

  /* Special style for the top "Show Equipment Form" button */
.top-button-wrapper {
  display: flex;
  justify-content: center;
  gap: 15px;  /* ⬅️ space between the two buttons */
  margin-top: 20px;
}

.toggle-form-btn {
  background-color: #2c3e50;
  color: white;
  padding: 12px 25px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  transition: background 0.3s;
}

.toggle-form-btn:hover {
  background-color: #34495e;
}



</style>

    <script>
  // ---------------- LOGIN ENFORCEMENT ----------------
  (function enforceLogin() {
  const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
  const userRole = localStorage.getItem("userRole");

  if (!isLoggedIn || (userRole !== "master" && userRole !== "logistics")) {
    // Show white background instantly
    document.documentElement.innerHTML = '<body style="background:#fff; margin:0"></body>';
    
    // Redirect to login
    window.location.replace("../../login.html");
  }
})();
</script>
</head>
<body>
<main>
<header>
<nav>
  <div class="nav-container">
    <div class="logo">RD8 BUILDERS CORP</div>
    <div class="menu-toggle" id="menu-toggle"><span></span><span></span><span></span></div>
    <div class="nav-links" id="nav-links">
      <a href="../../Index.html" class="nav-item">Home</a>
      <a href="../../AboutUs.html" class="nav-item">About Us</a>
      <a href="../../CompanyProfile.html" class="nav-item">Company Profile</a>
      <a href="../../ContactUs.html" class="nav-item">Contact Us</a>
      <a href="#" class="nav-item" id="authLink">Login</a>
    </div>
  </div>
</nav>
<a class="back-button" href="Logistics.html">← Back to Logistics</a>
</header>

<h1>EQUIPMENT HISTORY RECORD</h1>

<div class="top-button-wrapper">
  <button class="toggle-form-btn" onclick="showEquipmentForm()">Create Equipment Details</button>
  <button class="toggle-form-btn" onclick="generateEquipmentRecord()">Generate Equipment Record</button>
</div>

<!-- Hidden form -->
<div id="equipmentFormWrapper" class="form-container" style="display:none;">
  <div class="form-group"><label>Equipment Name:</label><input type="text" id="equipmentName"></div>
  <div class="form-group"><label>Equipment Code:</label><input type="text" id="equipmentCode"></div>
  <div class="form-group"><label>Plate Number:</label><input type="text" id="plateNumber"></div>
  <div class="form-group"><label>Engine Number:</label><input type="text" id="engineNumber"></div>
  <div class="form-group"><label>Brand Model:</label><input type="text" id="brandModel"></div>

  <div class="button-wrapper">
    <button onclick="postDetails()">Submit</button>
    <button onclick="toggleEditMode()">Edit Mode</button>
    <button onclick="hideEquipmentForm()">Hide Form</button>
  </div>
</div>

<!-- Equipment Table Wrapper -->
<div id="equipmentTableWrapper" style="display:none; max-width:900px; margin:20px auto; text-align:center;">
  <div>
    <label for="equipmentDropdown" style="font-weight:bold; display:block; margin-bottom:5px;">Choose Equipment:</label>
    <select id="equipmentDropdown" style="padding:10px; border-radius:6px; font-size:16px; min-width:200px;" onchange="onChooseEquipment()">
      <option value="">-- Select Equipment --</option>
    </select>
  </div>

  <!-- Date Filter in its own wrapper below dropdown -->
  <div id="dateFilterWrapper" style="display:none; text-align:center; margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:6px; background:#f9f9f9; max-width:200px; margin-left:auto; margin-right:auto;">
    <label style="margin-right:5px;">From: <input type="date" id="filterStartDate" style="padding:5px; border-radius:4px;"></label>
    <label style="margin-right:5px;">To: <input type="date" id="filterEndDate" style="padding:5px; border-radius:4px;"></label>
    <button onclick="filterByDateRange()" style="padding:5px 12px; margin-right:5px; cursor:pointer; border-radius:4px; background:#2c3e50; color:white; border:none;">Filter</button>
    <button onclick="clearDateFilter()" style="padding:5px 12px; cursor:pointer; border-radius:4px; background:#e74c3c; color:white; border:none;">Clear</button>
  </div>

  <!-- Buttons will appear here after choosing -->
  <div id="equipmentActions" style="margin-top:20px;"></div>
</div>

<!-- Job Order Summary Table -->
<div id="jobOrderSummaryWrapper" style="max-width:900px; margin:20px auto; display:none;"></div>

<!-- ✅ Job Order Form (hidden by default) -->
<div id="jobOrderFormWrapper" class="form-container" style="display:none;">
  <h2 style="text-align:center; margin-bottom:15px;">Job Order Form</h2>

  <div class="form-group">
    <label>Job Order No.:</label>
    <input type="text" id="jobOrderNo">
  </div>

  <div class="form-group">
    <label>Details of Repair:</label>
    <input type="text" id="detailsOfRepair">
  </div>

  <div class="form-group">
    <label>Date Started:</label>
    <input type="date" id="dateStarted">
  </div>

  <div class="form-group">
    <label>Date Completed:</label>
    <input type="date" id="dateCompleted">
  </div>

  <div class="form-group">
    <label>Major Spare Parts Used:</label>
    <div id="sparePartsContainer">
      <input type="text" class="sparePart" placeholder="Enter spare part">
    </div>
    <button type="button" class="action-button" onclick="addSparePart()">+ Add Spare Part</button>
  </div>

  <div class="form-group">
    <label>Total Cost:</label>
    <input type="number" id="totalCost" placeholder="₱ 0.00">
  </div>

  <div class="button-wrapper">
    <button onclick="submitJobOrder()">Submit</button>
    <button onclick="hideJobOrderForm()">Hide Form</button>
  </div>
</div>

<!-- Container for Job Order Summary Table -->
<div id="dateFilterWrapper" style="text-align:center; margin-bottom:15px; display:none;">
    <label>From: <input type="date" id="filterStartDate"></label>
    <label>To: <input type="date" id="filterEndDate"></label>
    <button onclick="filterByDateRange()" style="padding:5px 15px; margin-left:10px; cursor:pointer;">Filter</button>
    <button onclick="clearDateFilter()" style="padding:5px 15px; margin-left:5px; cursor:pointer;">Clear</button>
</div>
<div id="jobOrderSummaryWrapper" style="max-width:900px; margin:20px auto; display:none;"></div>


<script>

  let filteredJobOrders = []; // global filtered array

function applyDateFilter() {
    generateJobOrderSummary(); // auto-uses startDate/endDate inside
}


function clearDateFilter() {
    document.getElementById("filterStartDate").value = "";
    document.getElementById("filterEndDate").value = "";
    filteredJobOrders = [];
    generateJobOrderSummary();
}

// ✅ Show Job Order Form
function showJobOrderForm() {
    document.getElementById("jobOrderFormWrapper").style.display = "block";
}

// ✅ Hide Job Order Form
function hideJobOrderForm() {
    document.getElementById("jobOrderFormWrapper").style.display = "none";
}

// ✅ Add spare part input dynamically
function addSparePart() {
    const container = document.getElementById("sparePartsContainer");
    const input = document.createElement("input");
    input.type = "text";
    input.className = "sparePart";
    input.placeholder = "Enter spare part";
    input.style.marginTop = "8px";
    container.appendChild(input);
}


// ✅ Save Job Order to localStorage
let jobOrders = JSON.parse(localStorage.getItem("jobOrders")) || [];

function submitJobOrder() {
    const selectedEquipment = document.getElementById("equipmentDropdown").value;
    if (!selectedEquipment) {
        alert("Please select equipment before creating a job order.");
        return;
    }

    const orderNo = document.getElementById("jobOrderNo").value.trim();
    const details = document.getElementById("detailsOfRepair").value.trim();
    const started = document.getElementById("dateStarted").value;
    const completed = document.getElementById("dateCompleted").value;
    const cost = document.getElementById("totalCost").value.trim();

    const spareParts = Array.from(document.querySelectorAll(".sparePart"))
      .map(input => input.value.trim())
      .filter(v => v !== "");

    if (!orderNo) {
        alert("Please enter Job Order No.");
        return;
    }

    const jobOrder = {
        equipment: selectedEquipment, // ✅ link to equipment
        orderNo,
        details,
        started,
        completed,
        spareParts,
        cost
    };

    jobOrders.push(jobOrder);
    localStorage.setItem("jobOrders", JSON.stringify(jobOrders));

    alert("Job Order saved for " + selectedEquipment + "- JOB ORDER NUMBER:" + orderNo);

    // Reset form
    document.getElementById("jobOrderNo").value = "";
    document.getElementById("detailsOfRepair").value = "";
    document.getElementById("dateStarted").value = "";
    document.getElementById("dateCompleted").value = "";
    document.getElementById("totalCost").value = "";
    document.getElementById("sparePartsContainer").innerHTML =
      '<input type="text" class="sparePart" placeholder="Enter spare part">';
}

</script>


</main>

<footer class="footer">
  <p>&copy; Kurth Clarenze Lacsinto Novesteras. All rights reserved.</p>
</footer>

<script>

// ✅ Retrieve saved equipment from localStorage
let equipmentList = JSON.parse(localStorage.getItem("equipmentList")) || [];

function postDetails() {
    const name = document.getElementById("equipmentName").value.trim();
    const code = document.getElementById("equipmentCode").value.trim();
    const plate = document.getElementById("plateNumber").value.trim();
    const engine = document.getElementById("engineNumber").value.trim();
    const brand = document.getElementById("brandModel").value.trim();

    if (!name) {
        alert("Please enter an Equipment Name before submitting.");
        return;
    }

    // Save as an object
    const equipment = {
        name,
        code,
        plate,
        engine,
        brand
    };

    equipmentList.push(equipment);

    // ✅ Persist to localStorage
    localStorage.setItem("equipmentList", JSON.stringify(equipmentList));

    alert("Equipment saved: " + name);

    // Reset fields
    document.getElementById("equipmentName").value = "";
    document.getElementById("equipmentCode").value = "";
    document.getElementById("plateNumber").value = "";
    document.getElementById("engineNumber").value = "";
    document.getElementById("brandModel").value = "";
}

function generateEquipmentRecord() {
    const wrapper = document.getElementById("equipmentTableWrapper");
    const dropdown = document.getElementById("equipmentDropdown");

    // Always reload from localStorage
    equipmentList = JSON.parse(localStorage.getItem("equipmentList")) || [];

    // Reset dropdown
    dropdown.innerHTML = `<option value="">-- Select Equipment --</option>`;

    // Populate with names only
    equipmentList.forEach(eq => {
        const option = document.createElement("option");
        option.value = eq.name;
        option.textContent = eq.name;
        dropdown.appendChild(option);
    });

    wrapper.style.display = "block";
}

function hideEquipmentForm(){
    document.getElementById("equipmentFormWrapper").style.display = "none";
}

function showEquipmentForm(){
    document.getElementById("equipmentFormWrapper").style.display = "block";
}

const authLink=document.getElementById("authLink");
function updateAuthUI(){
    const isLoggedIn=localStorage.getItem("isLoggedIn")==="true";
    if(isLoggedIn){ 
        authLink.textContent="Logout"; 
        authLink.onclick=()=>{ if(confirm("Logout?")){localStorage.removeItem("isLoggedIn");window.location.href="../../login.html";} }; 
    } else { 
        authLink.textContent="Login"; 
        authLink.onclick=()=>{window.location.href="../../login.html";}; 
    }
}

function onChooseEquipment() {
    const dropdown = document.getElementById("equipmentDropdown");
    const actionsDiv = document.getElementById("equipmentActions");
    const selected = dropdown.value;

    // Clear previous buttons
    actionsDiv.innerHTML = "";

    if (selected) {
        const btnWrapper = document.createElement("div");
        btnWrapper.className = "top-button-wrapper";

        // Create Job Order button
        const jobBtn = document.createElement("button");
        jobBtn.textContent = "Create Job Order";
        jobBtn.className = "toggle-form-btn";
        jobBtn.onclick = () => showJobOrderForm();

        // Generate Record Summary button
        const summaryBtn = document.createElement("button");
        summaryBtn.textContent = "Generate Record Summary";
        summaryBtn.className = "toggle-form-btn";
        summaryBtn.onclick = () => generateJobOrderSummary();

        // Sort by Date button
        const sortBtn = document.createElement("button");
        sortBtn.textContent = "Sort by Date";
        sortBtn.className = "toggle-form-btn";
        sortBtn.style.backgroundColor = "#2980b9"; // optional color
        sortBtn.style.color = "white";
        sortBtn.onclick = () => sortJobOrdersByDate(selected);

        // Delete Equipment button
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete Equipment";
        deleteBtn.className = "toggle-form-btn";
        deleteBtn.style.backgroundColor = "#e74c3c"; // red
        deleteBtn.style.color = "white";
        deleteBtn.onclick = () => deleteEquipment(selected);

        // Append buttons to wrapper
        btnWrapper.appendChild(jobBtn);
        btnWrapper.appendChild(summaryBtn);
        btnWrapper.appendChild(sortBtn);
        btnWrapper.appendChild(deleteBtn);

        actionsDiv.appendChild(btnWrapper);
    }
}

function sortJobOrdersByDate(equipmentName) {
    if (!equipmentName) return;

    let orders = jobOrders.filter(o => o.equipment === equipmentName);

    if (orders.length === 0) {
        alert("No job orders to sort.");
        return;
    }

    // Sort by Date Started ascending
    orders.sort((a, b) => new Date(a.started) - new Date(b.started));

    // If you want descending, use: new Date(b.started) - new Date(a.started);

    // Update the filteredJobOrders array so generateJobOrderSummary can use it
    filteredJobOrders = orders;

    // Regenerate table using the sorted array
    generateJobOrderSummary(true);
}


function deleteEquipment(name) {
    if (confirm(`Are you sure you want to delete equipment "${name}" and all its job orders?`)) {
        // Remove from equipmentList
        equipmentList = equipmentList.filter(eq => eq.name !== name);
        localStorage.setItem("equipmentList", JSON.stringify(equipmentList));

        // Remove related job orders
        jobOrders = jobOrders.filter(order => order.equipment !== name);
        localStorage.setItem("jobOrders", JSON.stringify(jobOrders));

        alert(`Equipment "${name}" deleted successfully.`);

        // Refresh dropdown and UI
        generateEquipmentRecord();
        document.getElementById("equipmentActions").innerHTML = "";
        document.getElementById("jobOrderSummaryWrapper").style.display = "none";
    }
}

// ✅ Filter Job Orders by Date Button
function filterByDateRange() {
    const selectedEquipment = document.getElementById("equipmentDropdown").value;
    const start = document.getElementById("filterStartDate").value;
    const end = document.getElementById("filterEndDate").value;

    if (!selectedEquipment) {
        alert("Please select an equipment first.");
        return;
    }
    if (!start || !end) {
        alert("Please select both start and end dates.");
        return;
    }

    jobOrders = JSON.parse(localStorage.getItem("jobOrders")) || [];

    // Filter job orders by equipment and date range
    filteredJobOrders = jobOrders.filter(order => 
        order.equipment === selectedEquipment &&
        order.started >= start &&
        order.completed <= end
    );

    if (filteredJobOrders.length === 0) {
        alert("No job orders found in this date range.");
    }

    // Generate summary using filtered data
    generateJobOrderSummary(true); // ✅ pass true to use filteredJobOrders
}

// ✅ Clear date filter
function clearDateFilter() {
    document.getElementById("filterStartDate").value = "";
    document.getElementById("filterEndDate").value = "";
    filteredJobOrders = [];
    generateJobOrderSummary(); // regenerate full table
}

// ✅ Updated generateJobOrderSummary
function generateJobOrderSummary(useFiltered = false) {
    const selectedEquipment = document.getElementById("equipmentDropdown").value;
    const wrapper = document.getElementById("jobOrderSummaryWrapper");
    const dateFilter = document.getElementById("dateFilterWrapper");

    wrapper.innerHTML = "";

    // Show date filter only if equipment selected
    if (selectedEquipment) dateFilter.style.display = "block";
    else dateFilter.style.display = "none";

    jobOrders = JSON.parse(localStorage.getItem("jobOrders")) || [];

    const filteredOrders = useFiltered ? filteredJobOrders :
        jobOrders.filter(order => order.equipment === selectedEquipment);

    if (filteredOrders.length === 0) {
        wrapper.innerHTML = `<p style="text-align:center; font-weight:bold;">
            No job orders found for ${selectedEquipment}.
        </p>`;
        wrapper.style.display = "block";
        return;
    }

    // ✅ Build table
    let table = `<h3 style="text-align:center; margin-bottom:10px;">Job Orders for ${selectedEquipment}</h3>
    <table style="width:100%; border-collapse:collapse; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.1); text-align:center;">
        <thead>
            <tr style="background:#2c3e50; color:white;">
                <th style="padding:10px; border:1px solid #ddd;">Job Order No.</th>
                <th style="padding:10px; border:1px solid #ddd;">Details of Repair</th>
                <th style="padding:10px; border:1px solid #ddd;">Date Started</th>
                <th style="padding:10px; border:1px solid #ddd;">Date Completed</th>
                <th style="padding:10px; border:1px solid #ddd;">Spare Parts Used</th>
                <th style="padding:10px; border:1px solid #ddd;">Total Cost</th>
                <th style="padding:10px; border:1px solid #ddd;">Action</th>
            </tr>
        </thead>
        <tbody>`;

    filteredOrders.forEach(order => {
        const globalIndex = jobOrders.findIndex(o => o.orderNo === order.orderNo && o.equipment === order.equipment);

        table += `<tr>
            <td style="padding:10px; border:1px solid #ddd;">${order.orderNo}</td>
            <td style="padding:10px; border:1px solid #ddd;">${order.details}</td>
            <td style="padding:10px; border:1px solid #ddd;">${order.started}</td>
            <td style="padding:10px; border:1px solid #ddd;">${order.completed}</td>
            <td style="padding:10px; border:1px solid #ddd;">${order.spareParts.join(", ")}</td>
            <td style="padding:10px; border:1px solid #ddd;">₱ ${order.cost}</td>
            <td style="padding:10px; border:1px solid #ddd;">
                <button onclick="removeJobOrder(${globalIndex})" style="background:#e74c3c; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">
                    Remove
                </button>
            </td>
        </tr>`;
    });

    table += "</tbody></table>";
    wrapper.innerHTML = table;
    wrapper.style.display = "block";

    // ✅ Download button
    const btnWrapper = document.createElement("div");
    btnWrapper.style.display = "flex";
    btnWrapper.style.justifyContent = "center";
    btnWrapper.style.marginTop = "15px";

    const downloadBtn = document.createElement("button");
    downloadBtn.textContent = "DOWNLOAD SUMMARY";
    downloadBtn.style.padding = "10px 20px";
    downloadBtn.style.background = "#27ae60";
    downloadBtn.style.color = "white";
    downloadBtn.style.border = "none";
    downloadBtn.style.borderRadius = "6px";
    downloadBtn.style.cursor = "pointer";

    // ✅ Pass useFiltered flag
    downloadBtn.onclick = () => downloadSummary(selectedEquipment, useFiltered);

    btnWrapper.appendChild(downloadBtn);
    wrapper.appendChild(btnWrapper);
}





function generateJobOrderSummary(useFiltered = false) {
    const selectedEquipment = document.getElementById("equipmentDropdown").value;
    const wrapper = document.getElementById("jobOrderSummaryWrapper");
    const dateFilter = document.getElementById("dateFilterWrapper");

    wrapper.innerHTML = "";

    // Show date filter only if equipment is selected
    if (selectedEquipment) {
        dateFilter.style.display = "block";
    } else {
        dateFilter.style.display = "none";
        return;
    }

    // Load job orders
    jobOrders = JSON.parse(localStorage.getItem("jobOrders")) || [];

    // Use filtered array if requested
    const filteredOrders = useFiltered ? filteredJobOrders : jobOrders.filter(order => order.equipment === selectedEquipment);

    if (filteredOrders.length === 0) {
        wrapper.innerHTML = `<p style="text-align:center; font-weight:bold;">
            No job orders found for ${selectedEquipment}${useFiltered ? " within the selected date range" : ""}.
        </p>`;
        wrapper.style.display = "block";
        return;
    }

    // Build table
    let table = `<h3 style="text-align:center; margin-bottom:10px;">Job Orders for ${selectedEquipment}</h3>
    <table style="width:100%; border-collapse:collapse; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.1); text-align:center;">
        <thead>
            <tr style="background:#2c3e50; color:white;">
                <th style="padding:10px; border:1px solid #ddd;">Job Order No.</th>
                <th style="padding:10px; border:1px solid #ddd;">Details of Repair</th>
                <th style="padding:10px; border:1px solid #ddd;">Date Started</th>
                <th style="padding:10px; border:1px solid #ddd;">Date Completed</th>
                <th style="padding:10px; border:1px solid #ddd;">Spare Parts Used</th>
                <th style="padding:10px; border:1px solid #ddd;">Total Cost</th>
                <th style="padding:10px; border:1px solid #ddd;">Action</th>
            </tr>
        </thead>
        <tbody>`;

    filteredOrders.forEach(order => {
        const globalIndex = jobOrders.findIndex(o => o.orderNo === order.orderNo && o.equipment === order.equipment);
        table += `
            <tr>
                <td style="padding:10px; border:1px solid #ddd;">${order.orderNo}</td>
                <td style="padding:10px; border:1px solid #ddd;">${order.details}</td>
                <td style="padding:10px; border:1px solid #ddd;">${order.started}</td>
                <td style="padding:10px; border:1px solid #ddd;">${order.completed}</td>
                <td style="padding:10px; border:1px solid #ddd;">${order.spareParts.join(", ")}</td>
                <td style="padding:10px; border:1px solid #ddd;">₱ ${order.cost}</td>
                <td style="padding:10px; border:1px solid #ddd;">
                    <button onclick="removeJobOrder(${globalIndex})" style="background:#e74c3c; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer;">
                        Remove
                    </button>
                </td>
            </tr>`;
    });

    table += "</tbody></table>";
    wrapper.innerHTML = table;
    wrapper.style.display = "block";

    // Add Download button
    const btnWrapper = document.createElement("div");
    btnWrapper.style.display = "flex";
    btnWrapper.style.justifyContent = "center";
    btnWrapper.style.marginTop = "15px";

    const downloadBtn = document.createElement("button");
    downloadBtn.textContent = "DOWNLOAD SUMMARY";
    downloadBtn.style.padding = "10px 20px";
    downloadBtn.style.background = "#27ae60";
    downloadBtn.style.color = "white";
    downloadBtn.style.border = "none";
    downloadBtn.style.borderRadius = "6px";
    downloadBtn.style.cursor = "pointer";

    downloadBtn.onclick = () => { downloadSummary(selectedEquipment, useFiltered); };

    btnWrapper.appendChild(downloadBtn);
    wrapper.appendChild(btnWrapper);
}



// ✅ Function to remove a job order
function removeJobOrder(index) {
    if (confirm("Are you sure you want to delete this job order?")) {
        let jobOrders = JSON.parse(localStorage.getItem("jobOrders")) || [];
        jobOrders.splice(index, 1);
        localStorage.setItem("jobOrders", JSON.stringify(jobOrders));
        generateJobOrderSummary();
    }
}

function downloadSummary(selectedEquipment, useFiltered = false) {
    if (!selectedEquipment) {
        alert("Please select an equipment first.");
        return;
    }

    const jobOrders = JSON.parse(localStorage.getItem("jobOrders")) || [];
    const equipmentList = JSON.parse(localStorage.getItem("equipmentList")) || [];
    const eq = equipmentList.find(e => e.name === selectedEquipment);
    if (!eq) return alert("Equipment details not found.");

    // Use filteredJobOrders if useFiltered=true, otherwise all for this equipment
    const ordersToDownload = useFiltered ? filteredJobOrders : jobOrders.filter(o => o.equipment === selectedEquipment);

    if (ordersToDownload.length === 0) {
        alert("No job orders to download for this equipment.");
        return;
    }

    // Create worksheet data array
    const wsData = [];
    wsData.push([]);
    wsData.push(["EQUIPMENT HISTORY RECORD"]);
    wsData.push(["EQUIPMENT NAME", eq.name, "PLATE NO.", eq.plate, "BRAND/MODEL", eq.brand]);
    wsData.push(["EQUIPMENT CODE", eq.code, "ENGINE NO.", eq.engine, "", ""]);
    wsData.push([]);
    wsData.push([]);
    wsData.push(["JOB ORDER NO.", "DETAILS OF REPAIR", "DATE STARTED", "DATE COMPLETED", "MAJOR SPARE PARTS", "COST"]);

    ordersToDownload.forEach(order => {
        wsData.push([
            order.orderNo,
            order.details,
            order.started,
            order.completed,
            order.spareParts.join(", "),
            order.cost
        ]);
    });

    const totalCost = ordersToDownload.reduce((sum, o) => sum + Number(o.cost || 0), 0);
    wsData.push(["GRAND TOTAL", "", "", "", "", totalCost]);

    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Merges
    ws['!merges'] = [
        { s: { r:1, c:0 }, e: { r:1, c:5 } },
        { s: { r:2, c:4 }, e: { r:2, c:5 } },
        { s: { r:3, c:4 }, e: { r:3, c:5 } },
        { s: { r:wsData.length-1, c:0 }, e: { r:wsData.length-1, c:4 } }
    ];

    // Set column widths
    ws['!cols'] = [
        { wch: 17 }, { wch: 25 }, { wch: 15 }, { wch: 15 }, { wch: 40 }, { wch: 12 }
    ];

    // Apply wrapText style to Major Spare Parts column (index 4)
    for(let r=8; r<wsData.length-1; r++){
        const cellAddr = XLSX.utils.encode_cell({r:r, c:4});
        if(ws[cellAddr]) {
            ws[cellAddr].s = { alignment: { wrapText: true, vertical: "top", horizontal: "left" } };
        }
    }

    // Append worksheet
    XLSX.utils.book_append_sheet(wb, ws, "Equipment Record");

    // Write workbook
    XLSX.writeFile(wb, `${selectedEquipment}_History_Record.xlsx`, { bookType: 'xlsx', cellStyles: true });
}




window.onload = () => { updateAuthUI(); };
</script>


<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</body>
</html>
