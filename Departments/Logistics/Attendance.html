<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attendance</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      display: flex;
      flex-direction: column;
      font-family: 'Montserrat', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    main { flex: 1; }

    nav {
      background-color: #2c3e50;
      padding: 15px 25px;
      color: white;
    }

    .nav-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .logo {
      font-size: 20px;
      font-weight: 700;
      color: white;
    }

    .nav-links {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .nav-item, .nav-item-button {
      color: white;
      text-decoration: none;
      font-size: 16px;
      padding: 10px 15px;
      background: none;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .nav-item:hover, .nav-item-button:hover {
      background-color: white;
      color: #2c3e50;
    }

    .menu-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      margin-left: auto;
      gap: 4px;
    }

    .menu-toggle span {
      height: 3px;
      width: 25px;
      background: white;
      border-radius: 3px;
    }

    .nav-links.show {
      display: flex;
      flex-direction: column;
      width: 100%;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .menu-toggle { display: flex; }
      .nav-links { display: none; flex-direction: column; width: 100%; margin-top: 10px; }
      .nav-item { width: 100%; padding: 10px 0; }
    }

    .back-button {
      display: block;
      margin: 10px 20px 0;
      text-align: left;
      background-color: #2c3e50;
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      text-decoration: none;
      width: fit-content;
    }

    .back-button:hover { background-color: #34495e; }

    h1 {
      text-align: center;
      color: #2c3e50;
      font-size: 24px;
      margin-top: 20px;
    }

    .form-container {
      background: #2c3e50;
      color: white;
      max-width: 800px;
      margin: 20px auto;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
    }
    textarea { resize: vertical; }

    .button-wrapper {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }

    .button-wrapper button {
      background-color: #ffffff;
      color: #2c3e50;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      max-width: 150px;
      width: 100%;
    }
    .button-wrapper button:hover { background-color: #ddd; }

    .table-wrapper {
      overflow-x: auto; 
      overflow-y: auto;
      margin: 30px auto;
      max-width: 1300px;
      max-height: 500px;
      border: 1px solid #ccc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
      background-color: white;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }

    th { background-color: #2c3e50; color: white; }
    td[contenteditable="true"] { background-color: white; }
    td.editing { outline: 2px solid #3498db; }

    .footer {
      background-color: #2c3e50;
      color: white;
      text-align: center;
      padding: 15px 20px;
      margin-top: 40px;
    }

    input:disabled,
    textarea:disabled,
    button:disabled {
      background-color: #ccc;
      color: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }

    input[type="date"] { width: 150px; }


    .sort-button {
  background-color: #2c3e50;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 15px;
  cursor: pointer;
  margin: 0 5px;
  transition: transform 0.1s, background-color 0.2s;
}

.sort-button:hover {
  background-color: #34495e;
}

.sort-button:active {
  transform: scale(0.95);
  background-color: #1f2d3a; /* slightly darker on click */
}



  </style>
</head>
<body>
<main>
<header>
<nav>
  <div class="nav-container">
    <div class="logo">RD8 BUILDERS CORP</div>
    <div class="menu-toggle" id="menu-toggle">
      <span></span><span></span><span></span>
    </div>
    <div class="nav-links" id="nav-links">
      <a href="../../Index.html" class="nav-item">Home</a>
      <a href="../../AboutUs.html" class="nav-item">About Us</a>
      <a href="../../CompanyProfile.html" class="nav-item">Company Profile</a>
      <a href="../../ContactUs.html" class="nav-item">Contact Us</a>
      <a href="#" class="nav-item" id="authLink">Login</a>
    </div>
  </div>
</nav>
<a class="back-button" href="Logistics.html">‚Üê Back to Logistics</a>
</header>

<h1>ATTENDANCE</h1>

<div class="form-container">
  <div class="form-group"><label>Date:</label><input type="date" id="date"></div>
  <div class="form-group"><label>Operator / Driver:</label><input type="text" id="operator"></div>
  <div class="form-group"><label>Equipment / Vehicle:</label><input type="text" id="vehicle"></div>
  <div class="form-group"><label>Site:</label><input type="text" id="site"></div>
  <div class="form-group"><label>Time In:</label><input type="time" id="timeIn"></div>
  <div class="form-group">
  <label>Time Start (Morning):</label>
  <div style="display:flex; gap:10px;">
    <input type="time" id="timeStartMorningFrom">
    <span style="color:white;align-self:center;">to</span>
    <input type="time" id="timeStartMorningTo">
  </div>
</div>

<div class="form-group">
  <label>Time Start (Afternoon):</label>
  <div style="display:flex; gap:10px;">
    <input type="time" id="timeStartAfternoonFrom">
    <span style="color:white;align-self:center;">to</span>
    <input type="time" id="timeStartAfternoonTo">
  </div>
</div>

  <div class="form-group"><label>Time Out:</label><input type="time" id="timeOut"></div>
  <div class="form-group"><label>Allowances:</label><input type="text" id="allowances"></div>

  <div class="button-wrapper">
    <button onclick="postDetails()">Submit</button>
    <button onclick="toggleEditMode()">Edit Mode</button>
  </div>
</div>

<div style="text-align:center; margin: 20px;">
  <button class="sort-button" onclick="sortBy('date')">Sort by Date</button>
  <button class="sort-button" onclick="sortBy('operator')">Sort by Operator</button>
  <button class="sort-button" onclick="sortBy('vehicle')">Sort by Vehicle</button>
  <button class="sort-button" onclick="sortBy('site')">Sort by Site</button>
</div>

<!-- Remove Confirmation Modal -->
<div id="removeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:white; padding:20px; border-radius:10px; max-width:400px; width:90%; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,0.3);">
    <p style="font-size:18px; margin-bottom:20px;">Are you sure you want to remove this entry?</p>
    <div style="display:flex; justify-content:center; gap:20px;">
      <button id="confirmRemove" style="background:#e74c3c; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">Yes</button>
      <button id="cancelRemove" style="background:#ccc; color:#333; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>

<div class="table-wrapper">
  <table>
    <thead>
  <tr>
    <th>Date</th>
    <th>Operator / Driver</th>
    <th>Equipment / Vehicle</th>
    <th>Site</th>
    <th>Time In</th>
    <th>Time Start (Morning)</th>
    <th>Time Start (Afternoon)</th>
    <th>Time Out</th>
    <th>Allowances</th>
    <th>Remove</th>
  </tr>
</thead>

    <tbody id="dataBody"></tbody>
  </table>
</div>

<div style="text-align: center; margin: 20px;">
  <label>From: <input type="date" id="fromDate"></label>
  <label>To: <input type="date" id="toDate"></label>
  <button onclick="downloadExcel()" style="
    background-color: #2c3e50;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
  ">Download Excel</button>
</div>
</main>

<footer class="footer">
  <p>&copy; Kurth Clarenze Lacsinto Novesteras. All rights reserved.</p>
</footer>

<script>

// ---------------- LOGIN ENFORCEMENT ----------------
(function enforceLogin() {
    const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";

    if (!isLoggedIn) {
        // Clear the page content
        document.documentElement.innerHTML = ""; 
        // Optional: set background white
        document.body.style.backgroundColor = "#fff";

        // Force redirect to login
        window.location.replace("../../login.html");
    }
})();

    const authLink = document.getElementById("authLink");
    const deptDropdown = document.getElementById("deptDropdown");
    const deptList = document.getElementById("deptList");
    const menuToggle = document.getElementById("menu-toggle");
    const navLinks = document.getElementById("nav-links");

    // Protect this page
    const isLoggedIn = localStorage.getItem("isLoggedIn");
    const userRole = localStorage.getItem("userRole");

    if (!isLoggedIn || (userRole !== "logistics" && userRole !== "master")) {
      alert("Access denied.");
      window.location.href = "../../login.html";
    }

    menuToggle.addEventListener("click", () => {
      navLinks.classList.toggle("show");
    });

    function updateAuthUI() {
      if (isLoggedIn === "true") {
        authLink.textContent = "Logout";
        deptDropdown.style.display = "block";

        authLink.onclick = () => {
          const confirmLogout = confirm("Are you sure you want to logout?");
          if (confirmLogout) {
            localStorage.removeItem("isLoggedIn");
            localStorage.removeItem("userRole");
            window.location.href = "../../login.html";
          }
        };

        // Render department links based on role
        if (userRole === "master") {
          deptList.innerHTML = `
            <a href="../Executive/Executive.html">Executive Department</a>
            <a href="../Admin/Admin.html">Admin Department</a>
            <a href="../Accounting/Accounting.html">Accounting Department</a>
            <a href="../Bidding/Bidding.html">Bidding Department</a>
            <a href="../Finance/Finance.html">Finance Department</a>
            <a href="../HR/HR.html">Human Resources Department</a>
            <a href="../IT/IT.html">IT Department</a>
            <a href="Logistics.html">Logistics Department</a>
            <a href="../Operations/Operations.html">Operations Department</a>
            <a href="../Purchasing/Purchasing.html">Purchasing Department</a>
          `;
        } else if (userRole === "logistics") {
          deptList.innerHTML = `
            <a href="Logistics.html">Logistics Department</a>
          `;
        }

      } else {
        authLink.textContent = "Login";
        deptDropdown.style.display = "none";
        authLink.onclick = () => {
          window.location.href = "../../login.html";
        };
      }
    }

    updateAuthUI();

  let sortOrder = { date: true, operator: true, vehicle: true, site: true }; // true = ascending

function sortBy(field){
  entries.sort((a,b)=>{
    let valA = a[field].toLowerCase ? a[field].toLowerCase() : a[field];
    let valB = b[field].toLowerCase ? b[field].toLowerCase() : b[field];

    if(valA < valB) return sortOrder[field] ? -1 : 1;
    if(valA > valB) return sortOrder[field] ? 1 : -1;
    return 0;
  });
  sortOrder[field] = !sortOrder[field]; // toggle ascending/descending
  updateTable();
}



  function formatTime(value){
  if (!value) return "00:00AM";
  let [hour, minute] = value.split(":");
  hour = parseInt(hour, 10);
  const ampm = hour >= 12 ? "PM" : "AM";
  hour = hour % 12 || 12;
  return `${hour}:${minute}${ampm}`;
}

function formatTimeRange(rangeStr){
  if(!rangeStr || typeof rangeStr !== "string") return "00:00am - 00:00pm";
  if(!rangeStr.includes("-")) return "00:00am - 00:00pm";
  let [from, to] = rangeStr.split(" - ");
  from = (from || "00:00").trim();
  to   = (to   || "12:00").trim();
  return `${formatTime(from)} - ${formatTime(to)}`;
}
  
  const entries=JSON.parse(localStorage.getItem("attendanceEntries")||"[]");
  let editingEnabled=false;

  function save(){localStorage.setItem("attendanceEntries",JSON.stringify(entries));}

  function postDetails(){
  const entry = {
    date: date.value || "TBD",
    operator: operator.value || "TBD",
    vehicle: vehicle.value || "DIDN'T USE",
    site: site.value || "TBD",

    timeIn: timeIn.value || "00:00",

        timeStartMorning: (timeStartMorningFrom.value && timeStartMorningTo.value) 
                  ? `${timeStartMorningFrom.value} - ${timeStartMorningTo.value}`
                  : "00:00 - 12:00",
        timeStartAfternoon: (timeStartAfternoonFrom.value && timeStartAfternoonTo.value) 
                  ? `${timeStartAfternoonFrom.value} - ${timeStartAfternoonTo.value}`
                  : "00:00 - 12:00",
    timeOut: timeOut.value || "00:00",              


    allowances: allowances.value || "TBD"
  };

  entries.push(entry); 
  save(); 
  updateTable();
  document.querySelectorAll(".form-container input").forEach(el=>el.value="");
}


  function updateTable() {
  const body = document.getElementById("dataBody");
  body.innerHTML = "";

  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;

  // Filter entries by date
  const filteredEntries = entries.filter(e => {
    if (!from && !to) return true;
    const entryDate = e.date;
    if (from && entryDate < from) return false;
    if (to && entryDate > to) return false;
    return true;
  });

  filteredEntries.forEach((e, i) => {
    const row = document.createElement("tr");

    Object.keys(e).forEach(key => {
      const td = document.createElement("td");

      if (editingEnabled) {
        // Time In / Time Out (single time inputs)
        if (key === "timeIn" || key === "timeOut") {
          const input = document.createElement("input");
          input.type = "time";
          input.value = e[key] && e[key] !== "00:00" ? e[key] : "";
          input.onchange = () => {
            e[key] = input.value || "00:00";
            save();
          };
          td.appendChild(input);
        }
        // Morning & Afternoon (two time inputs with "to")
        else if (key === "timeStartMorning" || key === "timeStartAfternoon") {
          let [fromTime, toTime] = e[key].includes("-")
            ? e[key].split(" - ")
            : ["00:00", "12:00"];

          const inputFrom = document.createElement("input");
          inputFrom.type = "time";
          inputFrom.value = fromTime.trim() || "";

          const span = document.createElement("span");
          span.textContent = " to ";

          const inputTo = document.createElement("input");
          inputTo.type = "time";
          inputTo.value = toTime.trim() || "";

          inputFrom.onchange = () => {
            e[key] = `${inputFrom.value || "00:00"} - ${inputTo.value || "12:00"}`;
            save();
          };
          inputTo.onchange = () => {
            e[key] = `${inputFrom.value || "00:00"} - ${inputTo.value || "12:00"}`;
            save();
          };

          td.appendChild(inputFrom);
          td.appendChild(span);
          td.appendChild(inputTo);
        }
        // All other editable text fields
        else {
          td.contentEditable = true;
          td.classList.add("editing");
          td.textContent = e[key];
          td.oninput = () => {
            entries[i][key] = td.textContent;
            save();
          };
        }
      } else {
        // Normal display mode
        if (key === "timeIn" || key === "timeOut") {
          td.textContent = e[key] ? formatTime(e[key]) : "00:00am";
        } else if (key === "timeStartMorning" || key === "timeStartAfternoon") {
          if (e[key].includes("-")) {
            let [from, to] = e[key].split(" - ");
            td.textContent = `${formatTime(from.trim())} - ${formatTime(to.trim())}`;
          } else {
            td.textContent = "00:00am - 00:00pm";
          }
        } else {
          td.textContent = e[key];
        }
      }

      row.appendChild(td);
    });

    // Remove button column
    const td = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "Remove";
    btn.style.background = "#e74c3c";
    btn.style.color = "white";
    btn.style.border = "none";
    btn.style.padding = "5px 10px";
    btn.style.borderRadius = "4px";

    btn.onclick = () => {
      const modal = document.getElementById("removeModal");
      modal.style.display = "flex";

      const confirmBtn = document.getElementById("confirmRemove");
      const cancelBtn = document.getElementById("cancelRemove");

      confirmBtn.onclick = () => {
        entries.splice(i, 1);
        save();
        updateTable();
        modal.style.display = "none";
      };

      cancelBtn.onclick = () => {
        modal.style.display = "none";
      };
    };

    td.appendChild(btn);
    row.appendChild(td);
    body.appendChild(row);
  });
}


// Trigger filter whenever dates change
document.getElementById("fromDate").addEventListener("change", updateTable);
document.getElementById("toDate").addEventListener("change", updateTable);


// helper: convert AM/PM string back to 24-hour format for input[type=time]
function convertTo24Hour(timeStr) {
  if(!timeStr) return "";
  const match = timeStr.match(/(\d+):(\d+)(am|pm)/i);
  if(!match) return "";
  let [_, h, m, ampm] = match;
  h = parseInt(h);
  if(ampm.toLowerCase()==="pm" && h<12) h+=12;
  if(ampm.toLowerCase()==="am" && h===12) h=0;
  return `${String(h).padStart(2,"0")}:${m}`;
}


  function toggleEditMode(){editingEnabled=!editingEnabled;updateTable();}

  function downloadExcel(){
  const from = document.getElementById("fromDate").value;
  const to   = document.getElementById("toDate").value;

  const filteredEntries = entries.filter(e => {
    if(!from && !to) return true;
    const d = e.date;
    if(from && d < from) return false;
    if(to && d > to) return false;
    return true;
  });

  const rows = [["Date","Operator","Vehicle","Site","Time In","Time Start (Morning)","Time Start (Afternoon)","Time Out","Allowances"]];

  filteredEntries.forEach(e => {
    rows.push([
      e.date,
      e.operator,
      e.vehicle,
      e.site,
      formatTime(e.timeIn || "00:00"),
      formatTimeRange(e.timeStartMorning),
      formatTimeRange(e.timeStartAfternoon),
      formatTime(e.timeOut || "00:00"),
      e.allowances
    ]);
  });

  const csv  = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv" });
  const a    = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "attendance.csv";
  a.click();
}



  window.onload=updateTable;
  menuToggle.addEventListener("click", () => {
    navLinks.classList.toggle("show");
  });

  function disableInteraction() {
    document.querySelectorAll("input, textarea, button").forEach(el => {
      el.disabled = true;
      el.style.cursor = "not-allowed";
    });
    editingEnabled = false;
    updateTable();
  }

  window.onload = () => {
    updateTable();
    updateAuthUI();
    if (localStorage.getItem("isLoggedIn") !== "true") {
      disableInteraction();
    }
  };
</script>
</body>
</html>
