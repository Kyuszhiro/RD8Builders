<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fuel Expense Summary</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ✅ Retained ALL your styles */
    * { box-sizing: border-box; }
    html, body { height: 100%; display: flex; flex-direction: column; font-family: 'Montserrat', sans-serif; background-color: #f4f4f4; margin: 0; padding: 0; }
    main { flex: 1; }
    nav { background-color: #2c3e50; padding: 15px 25px; color: white; }
    .nav-container { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .logo { font-size: 20px; font-weight: 700; color: white; }
    .nav-links { display: flex; flex-wrap: wrap; gap: 15px; }
    .nav-item, .nav-item-button { color: white; text-decoration: none; font-size: 16px; padding: 10px 15px; background: none; border: none; border-radius: 6px; cursor: pointer; }
    .nav-item:hover, .nav-item-button:hover { background-color: white; color: #2c3e50; }
    .menu-toggle { display: none; flex-direction: column; cursor: pointer; margin-left: auto; gap: 4px; }
    .menu-toggle span { height: 3px; width: 25px; background: white; border-radius: 3px; }
    .nav-links.show { display: flex; flex-direction: column; width: 100%; margin-top: 10px; }
    @media (max-width: 768px) { .menu-toggle { display: flex; } .nav-links { display: none; flex-direction: column; width: 100%; margin-top: 10px; } .nav-item { width: 100%; padding: 10px 0; } }
    .back-button { display: block; margin: 10px 20px 0; text-align: left; background-color: #2c3e50; color: white; padding: 10px 25px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; text-decoration: none; width: fit-content; }
    .back-button:hover { background-color: #34495e; }
    h1 { text-align: center; color: #2c3e50; font-size: 24px; margin-top: 20px; }
    .form-container { background: #2c3e50; color: white; max-width: 900px; margin: 20px auto; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input { width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 14px; }
    .button-wrapper { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    .button-wrapper button { background-color: #ffffff; color: #2c3e50; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; max-width: 150px; width: 100%; }
    .button-wrapper button:hover { background-color: #ddd; }
    .table-wrapper { overflow-x: auto; overflow-y: auto; margin: 30px auto; max-width: 1300px; max-height: 500px; border: 1px solid #ccc; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; background-color: white; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; font-size: 14px; }
    th { background-color: #2c3e50; color: white; }
    td[contenteditable="true"] { background-color: white; }
    td.editing { outline: 2px solid #3498db; }
    .footer { background-color: #2c3e50; color: white; text-align: center; padding: 15px 20px; margin-top: 40px; }
    input:disabled, button:disabled { background-color: #ccc; color: #555; cursor: not-allowed; opacity: 0.6; }
    .sort-button { background-color: #2c3e50; color: white; border: none; border-radius: 6px; padding: 8px 15px; cursor: pointer; margin: 0 5px; }
    .sort-button:hover { background-color: #34495e; }
    .grand-total-row td { font-size: 16px; padding: 12px; }

    .filter-container {
  background: #ffffff;
  max-width: 900px;
  margin: 20px auto;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: center;
  align-items: center;
}

.filter-container label {
  display: flex;
  flex-direction: column;
  font-weight: bold;
  color: #2c3e50;
  font-size: 14px;
  
}

.filter-container input {
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  margin-top: 5px;
}.filter-container {
  background: #ffffff;
  max-width: 900px;
  margin: 20px auto;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: center;
  align-items: center;
}

.filter-container label {
  display: flex;
  flex-direction: column;
  font-weight: bold;
  color: #2c3e50;
  font-size: 14px;
  
}

.filter-container input {
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 14px;
  margin-top: 5px;
}
  </style>

  <script>
  // ---------------- LOGIN ENFORCEMENT ----------------
  (function enforceLogin() {
  const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
  const userRole = localStorage.getItem("userRole");

  if (!isLoggedIn || (userRole !== "master" && userRole !== "logistics")) {
    // Show white background instantly
    document.documentElement.innerHTML = '<body style="background:#fff; margin:0"></body>';
    
    // Redirect to login
    window.location.replace("../../login.html");
  }
})();
</script>
</head>
<body>
<main>
<header>
<nav>
  <div class="nav-container">
    <div class="logo">RD8 BUILDERS CORP</div>
    <div class="menu-toggle" id="menu-toggle"><span></span><span></span><span></span></div>
    <div class="nav-links" id="nav-links">
      <a href="../../Index.html" class="nav-item">Home</a>
      <a href="../../AboutUs.html" class="nav-item">About Us</a>
      <a href="../../CompanyProfile.html" class="nav-item">Company Profile</a>
      <a href="../../ContactUs.html" class="nav-item">Contact Us</a>
      <a href="#" class="nav-item" id="authLink">Login</a>
    </div>
  </div>
</nav>
<a class="back-button" href="Logistics.html">← Back to Logistics</a>
</header>

<h1>FUEL EXPENSE SUMMARY</h1>

<div class="form-container">
  <div class="form-group"><label>Date:</label><input type="date" id="date"></div>
  <div class="form-group"><label>Equipment:</label><input type="text" id="equipment"></div>
  <div class="form-group"><label>Price per Liter:</label><input type="number" id="price"></div>
  <div class="form-group"><label>Liters:</label><input type="number" id="liters"></div>
  <div class="form-group"><label>Site:</label><input type="text" id="site"></div>

  <div class="button-wrapper">
    <button onclick="postDetails()">Submit</button>
    <button onclick="toggleEditMode()">Edit Mode</button>
  </div>
</div>

<div class="filter-container">
  <label>Start Date
  <input type="date" id="filterStartDate" onchange="applyFilters()">
</label>
<label>End Date
  <input type="date" id="filterEndDate" onchange="applyFilters()">
</label>
  <label>Equipment
    <input type="text" id="filterEquipment" oninput="applyFilters()" placeholder="Type equipment">
  </label>
  <label>Site
    <input type="text" id="filterSite" oninput="applyFilters()" placeholder="Type site">
  </label>
  

  <button onclick="clearFilters()" class="sort-button">Clear Filters</button>
</div>


<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Equipment</th>
        <th>Site</th>
        <th>Price/Liter</th>
        <th>Liters</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody id="dataBody"></tbody>
  </table>
</div>

<div style="text-align:center; margin: 20px;">
  <button onclick="generateSummary()" style="background-color: #27ae60;color: white;padding: 10px 20px;border: none;border-radius: 6px;cursor: pointer;font-size: 16px;">Generate Summary Report</button>
</div>

<div class="table-wrapper" id="summaryWrapper" style="display:none;">
  <h2 style="text-align:center; color:#2c3e50;">Summary Report</h2>
  <table id="summaryTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Equipment</th>
        <th>Site</th>
        <th>Price/Liter</th>
        <th>Liters</th>
        <th>Total Cost</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr class="grand-total-row">
        <td colspan="4" style="background:#2c3e50;color:white;font-weight:bold;text-align:center;">Grand Total</td>
        <td id="grandTotalLiters" style="background:#27ae60;color:white;font-weight:bold;"></td>
        <td id="grandTotalCost" style="background:#27ae60;color:white;font-weight:bold;"></td>
      </tr>
    </tfoot>
  </table>
</div>

<div style="text-align:center; margin: 10px;">
  <button id="downloadSummaryBtn" onclick="downloadSummary()" style="background-color: #2980b9;color: white;padding: 10px 20px;border: none;border-radius: 6px;cursor: pointer;font-size: 16px;display: none;">Download Summary Report</button>
</div>

</main>

<footer class="footer">
  <p>&copy; Kurth Clarenze Lacsinto Novesteras. All rights reserved.</p>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  let entries = JSON.parse(localStorage.getItem("fuelEntries") || "[]"); // ✅ unique key
  let editingEnabled = false;
  let lastSortField = null;
  let sortOrder = { date: true, equipment: true, site: true };
  let currentSortDirection = 1; // 1 = ascending, -1 = descending
  function save(){ localStorage.setItem("fuelEntries", JSON.stringify(entries)); }

function getFilteredEntries() {
  const fStart = document.getElementById("filterStartDate").value;
  const fEnd = document.getElementById("filterEndDate").value;
  const fEquip = document.getElementById("filterEquipment").value.toLowerCase();
  const fSite = document.getElementById("filterSite").value.toLowerCase();

  return entries.filter(e => {
    const entryDate = e.date;

    // ✅ Date range check
    const dateMatch = (!fStart || entryDate >= fStart) &&
                      (!fEnd || entryDate <= fEnd);

    // ✅ Equipment check
    const equipMatch = !fEquip || e.equipment.toLowerCase().includes(fEquip);

    // ✅ Site check (include ALL SITE always)
    const siteMatch = !fSite || e.site.toLowerCase().includes(fSite) || e.site.toLowerCase() === "all site";

    return dateMatch && equipMatch && siteMatch;
  });
}


  function applyFilters(){
  const body=document.getElementById("dataBody");
  body.innerHTML="";

  const filtered = getFilteredEntries();

  filtered.forEach((e,i)=>{
    const row=document.createElement("tr");
    ["date","equipment","site","price","liters"].forEach(key=>{
      const td=document.createElement("td");
      td.textContent=e[key];
      if(editingEnabled){
        td.contentEditable=true;
        td.classList.add("editing");
        td.oninput=()=>{ e[key]=td.textContent; save(); };
      }
      row.appendChild(td);
    });

    const tdRemove=document.createElement("td");
    const btn=document.createElement("button");
    btn.textContent="Remove";
    btn.style.background="#e74c3c"; 
    btn.style.color="white";
    btn.onclick=()=>{ 
      entries = entries.filter(x => x !== e);
      save(); 
      updateTable(); 
      applyFilters(); 
    };
    tdRemove.appendChild(btn);
    row.appendChild(tdRemove);

    body.appendChild(row);
  });
}


  function clearFilters() {
  document.getElementById("filterStartDate").value = "";
  document.getElementById("filterEndDate").value = "";
  document.getElementById("filterEquipment").value = "";
  document.getElementById("filterSite").value = "";
  updateTable();
}



  function postDetails() {
    const entry = {
      date: date.value,
      equipment: equipment.value,
      price: Number(price.value),
      liters: Number(liters.value),
      site: site.value
    };

    if(!entry.date || !entry.equipment){ alert("Fill required fields"); return; }

    entries.push(entry);
    save();
    updateTable();

    document.querySelectorAll(".form-container input").forEach(i=>i.value="");
  }

  function updateTable() {
  const body = document.getElementById("dataBody");
  body.innerHTML = "";

  entries.forEach((e,i)=>{
    const row = document.createElement("tr");

    ["date","equipment","site","price","liters"].forEach(key=>{
      const td=document.createElement("td");
      td.textContent=e[key];
      if(editingEnabled){ 
        td.contentEditable=true; 
        td.classList.add("editing"); 
        td.oninput=()=>{ entries[i][key]=td.textContent; save(); }; 
      }
      row.appendChild(td);
    });

    const tdRemove=document.createElement("td");
    const btn=document.createElement("button");
    btn.textContent="Remove";
    btn.style.background="#e74c3c"; 
    btn.style.color="white";
    btn.onclick=()=>{ entries.splice(i,1); save(); updateTable(); };
    tdRemove.appendChild(btn);
    row.appendChild(tdRemove);

    body.appendChild(row);
  });
}
function sortBy(field){
  entries.sort((a,b)=>{
    let valA=a[field]; let valB=b[field];
    if(valA<valB) return sortOrder[field]?-1:1;
    if(valA>valB) return sortOrder[field]?1:-1;
    return 0;
  });
  
  // toggle and save direction
  sortOrder[field] = !sortOrder[field];
  currentSortDirection = sortOrder[field] ? 1 : -1;
  lastSortField = field;

  updateTable();
}

  function toggleEditMode(){ editingEnabled=!editingEnabled; updateTable(); }

function generateSummary() {
  const tbody = document.querySelector("#summaryTable tbody");
  tbody.innerHTML = "";
  let totalCost = 0;
  let totalLiters = 0;

  // ✅ Use filtered entries (date range + equipment + site + ALL SITE)
  const filtered = getFilteredEntries();

  // ✅ Sort if needed
  const sortedEntries = [...filtered].sort((a,b) => {
    let field = lastSortField || "date";
    let valA = a[field], valB = b[field];
    if(valA < valB) return -1 * currentSortDirection;
    if(valA > valB) return 1 * currentSortDirection;
    return 0;
  });

  sortedEntries.forEach(e => {
    const tr = document.createElement("tr");
    const cost = e.price * e.liters;
    totalCost += cost;
    totalLiters += e.liters;
    tr.innerHTML = `
      <td>${e.date}</td>
      <td>${e.equipment}</td>
      <td>${e.site}</td>
      <td>${e.price.toLocaleString("en-US")}</td>
      <td>${e.liters.toLocaleString("en-US")}</td>
      <td>${cost.toLocaleString("en-US",{minimumFractionDigits:2})}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("grandTotalLiters").textContent = totalLiters.toLocaleString("en-US");
  document.getElementById("grandTotalCost").textContent = totalCost.toLocaleString("en-US",{minimumFractionDigits:2});

  document.getElementById("summaryWrapper").style.display = "block";
  document.getElementById("downloadSummaryBtn").style.display = "inline-block";
}


function downloadSummary(){
  const ws_data=[["ItemNo","Date","Equipment","Site","Price/Liter","Liters","Total Cost"]];
  let total=0, totalLiters=0;

  const filtered = getFilteredEntries();
  const sortedEntries = [...filtered].sort((a,b)=>{
    let field = lastSortField || "date";
    let valA=a[field], valB=b[field];
    if(valA<valB) return -1 * currentSortDirection;
    if(valA>valB) return 1 * currentSortDirection;
    return 0;
  });

  // ✅ Track per-equipment totals
  const equipmentTotals = {};

  sortedEntries.forEach((e,i)=>{
    const cost=e.price*e.liters;
    total+=cost;
    totalLiters+=e.liters;

    if(!equipmentTotals[e.equipment]) equipmentTotals[e.equipment]=0;
    equipmentTotals[e.equipment]+=cost;

    ws_data.push([
      i+1,
      e.date,
      e.equipment,
      e.site,
      e.price,
      e.liters,
      cost
    ]);
  });

  // ✅ Grand total row for main data
  ws_data.push([
    "Grand Total", "", "", "", "",
    totalLiters,
    total
  ]);

  // ✅ Blank row as spacing
  ws_data.push([]);

  // ✅ Fuel Expense Summary section
  ws_data.push(["Fuel Expense Summary Report"]); 
  ws_data.push(["Equipment Code", "Total Cost"]);

  Object.entries(equipmentTotals).forEach(([equip, cost])=>{
    ws_data.push([equip, cost]);
  });

  // ✅ Add Grand Total in Fuel Expense Summary Report
  ws_data.push(["Grand Total", total]);

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);

  // ✅ Set column widths
  ws['!cols'] = [
    { wch: 25 },
    { wch: 15 },
    { wch: 25 },
    { wch: 25 },
    { wch: 15 },
    { wch: 15 },
    { wch: 15 }
  ];

  // ✅ Apply number formatting
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let R=1; R<=range.e.r; R++){  
    if(ws[XLSX.utils.encode_cell({r:R,c:4})]) ws[XLSX.utils.encode_cell({r:R,c:4})].z = "#,##0.00"; 
    if(ws[XLSX.utils.encode_cell({r:R,c:5})]) ws[XLSX.utils.encode_cell({r:R,c:5})].z = "#,##0";    
    if(ws[XLSX.utils.encode_cell({r:R,c:6})]) ws[XLSX.utils.encode_cell({r:R,c:6})].z = "#,##0.00"; 
    if(ws[XLSX.utils.encode_cell({r:R,c:1})] && ws[XLSX.utils.encode_cell({r:R,c:1})].v === "Total Cost"){
      for(let r=R+1; r<=range.e.r; r++){
        if(ws[XLSX.utils.encode_cell({r:r,c:1})]) ws[XLSX.utils.encode_cell({r:r,c:1})].z = "#,##0.00";
      }
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, "Fuel Summary");
  XLSX.writeFile(wb, "fuel_summary.xlsx");
}

  const authLink=document.getElementById("authLink");
  function updateAuthUI(){
    const isLoggedIn=localStorage.getItem("isLoggedIn")==="true";
    if(isLoggedIn){ authLink.textContent="Logout"; authLink.onclick=()=>{ if(confirm("Logout?")){localStorage.removeItem("isLoggedIn");window.location.href="../../login.html";} }; }
    else { authLink.textContent="Login"; authLink.onclick=()=>{window.location.href="../../login.html";}; }
  }
  window.onload=()=>{ updateTable(); updateAuthUI(); if(localStorage.getItem("isLoggedIn")!=="true"){ document.querySelectorAll("input,button").forEach(el=>{ if(el.id!=="authLink") el.disabled=true; }); } };
</script>
</body>
</html>
